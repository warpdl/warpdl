# Progress: issue-129

## Goal

Auto-install native messaging host via package manager hooks

## GitHub Issue

**Issue #129**: feat: auto-install native messaging host via package manager hooks

### Summary

After #86 implemented the native messaging host, users still need to manually run:
```bash
warpdl native-host install --chrome-extension-id=... --firefox-extension-id=...
```

This should be automatic when installing via package managers (Homebrew, Scoop, APT, etc.).

### Proposed Changes

1. **Add default official extension IDs** - Create `internal/nativehost/defaults.go` with placeholder IDs
2. **Make install flags optional** - When no flags provided, use official defaults
3. **Add package manager hooks** - Homebrew, Scoop, DEB/RPM scripts

### Tasks from Issue

- [ ] Create `internal/nativehost/defaults.go` with placeholder IDs
- [ ] Update `cmd/nativehost/install.go` to use defaults when flags empty
- [ ] Update Homebrew formula with post_install/post_uninstall hooks
- [ ] Update Scoop manifest with hooks
- [ ] Add debian postinst/prerm scripts
- [ ] Add RPM spec hooks
- [ ] Update extension IDs once browser extension is published

### Blocked By

- Official WarpDL browser extension being published (to get the extension IDs)

### Related

- Implements follow-up to #86 (native messaging host implementation)

---

## Learnings

- Synthesis insight from quick mode: Existing `scripts/patch-scoop-manifest.sh` already patches Scoop manifests post-generation using jq - extend this pattern rather than fighting goreleaser limitations
- Pattern found: Homebrew hooks use Ruby try/rescue, DEB/RPM use POSIX `|| true`, Scoop uses PowerShell `2>$null`
- Scope decision: Focus on user-level installation only; system-wide native host installation is out of scope
- Assumption: Extension IDs will be added later when browser extensions are published; using empty string placeholders
- Area needing review: Windows native messaging uses registry keys (not just manifest files) - existing `internal/nativehost/platform_windows.go` may need verification

## Implementation Notes

- goreleaser does not support `post_uninstall` for Homebrew natively, but the brews config accepts arbitrary Ruby in the hooks
- Scoop manifest patching is done via shell script because goreleaser's native Scoop support lacks hook customization
- DEB/RPM scripts already exist and handle daemon lifecycle; native host is additive

## Completed Tasks
- [x] 1.1 Create defaults.go with placeholder extension IDs - b7ed36e
- [x] 1.2 Add --auto flag to install command - cd75dc3
- [x] 1.3 Modify install.go to use defaults and handle --auto - 25b986c
- [x] 1.4 Update Homebrew formula with post_install hook - e294b14
- [x] 1.5 POC Checkpoint - (verification task, no code changes)
- [x] 2.1 Add Homebrew post_uninstall hook - afe714c
- [x] 2.2 Update Scoop manifest patching for post_install - 64cd952
- [x] 2.3 Update Scoop manifest patching for pre_uninstall native host - 49e8b2b
- [x] 2.4 Update DEB/RPM postinstall.sh - 01c585e
- [x] 2.5 Update DEB/RPM preremove.sh - 36ba674
- [x] 3.1 Unit tests for defaults.go - b1484c7
- [x] 3.2 Integration tests for install --auto - fd5774e

## Current Task
Awaiting next task

## Next
Task 4.1: Local quality check

## Phase 1 Complete
POC verified: `warpdl native-host install --auto` exits 0 silently when no official extension IDs configured. All components working:
- defaults.go with OfficialChromeExtensionID/OfficialFirefoxExtensionID constants
- --auto flag in CLI
- Homebrew post_install hook

## Blockers

- Real extension IDs blocked until official WarpDL browser extension is published to Chrome Web Store and Firefox Add-ons
