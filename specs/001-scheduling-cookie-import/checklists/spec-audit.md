# Specification Quality Audit: Download Scheduling & Browser Cookie Import

**Purpose**: Comprehensive requirements quality validation for PR review — covers completeness, clarity, consistency, security/privacy, cross-platform parity, and edge case coverage across both scheduling and cookie import features
**Created**: 2026-02-28
**Last Updated**: 2026-02-28
**Feature**: [spec.md](../spec.md) | [plan.md](../plan.md) | [data-model.md](../data-model.md) | [contracts/cli-commands.md](../contracts/cli-commands.md)
**Audience**: PR reviewer (review gate before implementation)
**Depth**: Standard
**Focus**: Full spec audit, Security & privacy, Cross-platform, Edge cases & error handling

## Requirement Completeness

- [x] CHK001 - Are requirements defined for what happens when the daemon is not running at submission time (CLI sends `--start-at` but daemon is down)? — **No gap.** CLI already errors when daemon is unreachable (existing socket-connect failure path). No schedule can be created without daemon. Existing behavior is correct.
- [x] CHK002 - Is the behavior specified when a recurring download (`--schedule`) completes but the next occurrence's URL returns a different file (e.g., filename collision)? — **Covered by FR-009a.** Timestamp suffix on each trigger prevents collision. Each occurrence is independent — URL returning different content is normal download behavior.
- [x] CHK003 - Are requirements defined for displaying cookie source metadata in `warpdl list` output (which browser, path)? — **Resolved in contracts.** `Cookies` column shows browser name (`Firefox`, `Chrome`) for auto-detect/SQLite, filename (`cookies.txt`) for Netscape, `—` for none. Full path only in debug mode (CHK038 alignment).
- [x] CHK004 - Is the maximum number of concurrent recurring schedules specified or intentionally unbounded? — **Intentionally unbounded.** Queue concurrency cap (FR-010) naturally throttles execution. Artificial limit on schedule count adds complexity with no benefit for a single-user daemon.
- [x] CHK005 - Are requirements defined for what happens when a recurring download fails — does the next cron occurrence still trigger? — **Yes, next occurrence triggers regardless.** Each cron occurrence is independent. Failed runs retain failure status; new occurrence creates fresh download attempt with new timestamp suffix. Documented in contracts.
- [x] CHK006 - Is the behavior specified when `warpdl stop` targets a recurring schedule mid-download (download active, next occurrence pending)? Does it cancel only the current run or all future runs? — **Covered.** FR-008 + clarification: stop permanently cancels entire schedule. Spec, contracts, and clarifications are aligned.
- [x] CHK007 - Are requirements defined for how `--cookies-from auto` resolves when multiple Firefox profiles exist? — **Covered in research.md §4.** Parse `profiles.ini`, check `[Install*]` sections for `Default=`, fall back to `[Profile*]` with `Default=1`. Use first default profile found.
- [x] CHK008 - Is the cookie re-import behavior specified for all trigger scenarios: resume, retry, recurring, and work-steal segment respawn? — **Covered.** FR-023 + FR-024 handle resume, retry, recurring. Work-steal redistributes byte ranges within same session — cookies already in-memory, no re-import needed.
- [x] CHK009 - Are requirements defined for the speed limit scheduling format (`09:00-17:00:512KB`) — is the syntax formally specified with a grammar or just shown by example? — **Deferred (P3).** Speed limit scheduling depends on bandwidth throttling capability that doesn't exist yet (spec §Assumptions). No design work in current plan.
- [x] CHK010 - Is the interaction between `--schedule` combined with `--start-at` or `--start-in` specified in the spec (not just in contracts)? — **Resolved.** Added to spec FR-009: "MAY be combined with `--start-at` or `--start-in` to delay the first occurrence." Now in both spec and contracts.
- [x] CHK011 - Are requirements defined for notifying the user when a missed schedule fires on daemon restart (e.g., message format, where it appears)? — **Resolved in contracts.** Daemon log: `"Missed schedule: {name} (was {time}), starting now"`. `warpdl list` shows `missed` status with `"was {time} (starting now)"`.
- [x] CHK012 - Is the behavior specified when the user provides `--cookies-from` with a directory path instead of a file path? — **Resolved in contracts.** Reject with: `"error: {path} is a directory, expected a cookie file path or 'auto'"`. Validated via `os.Stat().IsDir()`.

## Requirement Clarity

- [x] CHK013 - Is "within 60 seconds of the scheduled time" (SC-001) clarified — does this mean ±60s or strictly 0-60s late? — **0–60s late.** Scheduler's max-sleep-cap is 60s, so worst case the trigger fires 60s after target. Typically much sooner when heap head is close.
- [x] CHK014 - Is "clear error message" (SC-007) defined with specific formatting or structural requirements, or is it left to implementer discretion? — **Implementer discretion matching existing style.** Follow existing codebase pattern: `"error: <description>"` or `"warning: <description>"`. No structural format spec needed — consistency with existing output is the requirement.
- [x] CHK015 - Is "documented priority order" (FR-016) specified — documented where? In CLI help text, man page, README, or just the spec? — **In `--cookies-from` flag help text and `warpdl download --help` output.** Also documented in spec (User Story 5) and research.md §4.
- [x] CHK016 - Is "relevant cookies for that domain" (User Story 3, acceptance scenario 1) defined with precision — does "relevant" mean exact domain, subdomains, parent domain, or path-matched? — **Precisely defined.** Exact domain match (`example.com`) OR dot-prefixed subdomain match (`.example.com`) OR wildcard suffix (`%.example.com`). Does NOT match parent domains. Consistent with research.md SQL queries. Documented in data-model validation rules.
- [x] CHK017 - Is "prompt for confirmation" (FR-007, past-time `--start-at`) specified for non-interactive contexts (piped input, scripts, daemon API calls)? — **Resolved.** FR-007 updated: always warn and start immediately. No interactive prompt. WarpDL is primarily daemon-based — interactive prompts are inappropriate.
- [x] CHK018 - Is the `--start-in` duration format exhaustively defined — are units like `d` (days), `s` (seconds), or compound forms like `1d2h30m` supported? — **Resolved.** FR-002 updated: Go's `time.ParseDuration` syntax. Supports `h`, `m`, `s`, and compounds (`1h30m`). Days (`d`) NOT supported — use `24h`. Documented in spec and contracts.
- [x] CHK019 - Is "first valid cookie store found" (FR-016) defined — does "valid" mean file exists, file is readable, file has correct format, or file contains cookies for the target domain? — **Defined.** "Valid" = file exists AND is readable AND has correct format (SQLite magic bytes + expected table, or Netscape header). Domain cookie check happens AFTER format detection — a valid store with zero domain cookies still triggers the "no cookies found" warning.
- [x] CHK020 - Is the `list` output format for missed downloads specified precisely — does "was 2026-02-27 03:00 (starting now)" come from requirements or is it an implementation example? — **Canonical format in contracts.** `"was {time} (starting now)"` is the specified output format for missed schedules.

## Requirement Consistency

- [x] CHK021 - Does FR-007 ("warn and prompt or start immediately") conflict with the acceptance scenario 4 ("warns the user... and prompts for confirmation or starts immediately")? The spec says "prompt OR start" but contracts say "starting download immediately" — which is canonical? — **Resolved.** FR-007 and acceptance scenario 4 both updated to "warn and start immediately." No interactive prompt. Contracts were already correct; spec now aligned.
- [x] CHK022 - Is the ScheduleState enum consistent between spec (§Key Entities: 5 states) and data-model.md (5 states)? Do all state names match exactly? — **Verified consistent.** Both list: `""`, `"scheduled"`, `"triggered"`, `"missed"`, `"cancelled"`. Names match exactly.
- [x] CHK023 - Are the auto-detection browser priority orders consistent between spec (User Story 5: "Firefox, Chrome, Chromium, Edge, LibreWolf") and research.md (Firefox, LibreWolf, Chrome, Chromium, Edge, Brave)? LibreWolf and Brave ordering differs. — **Resolved.** Spec User Story 5 updated to reference "documented priority order" with canonical list (Firefox, LibreWolf, Chrome, Chromium, Edge, Brave) from research.md §4. Unencrypted stores (Firefox, LibreWolf) intentionally first.
- [x] CHK024 - Does the spec's "no timezone suffix" (FR-001) align with the contracts' `YYYY-MM-DD HH:MM` format — is the format string consistent across spec, contracts, and error messages? — **Verified consistent.** All artifacts use `YYYY-MM-DD HH:MM`. Go format string: `"2006-01-02 15:04"`.
- [x] CHK025 - Is the cookie domain matching rule consistent between FR-017 ("matching the download URL's domain including subdomains") and research.md's SQL queries (exact match, dot-prefix, and LIKE wildcard)? — **Resolved.** FR-017's "including subdomains" means the SQL pattern: exact + dot-prefix + LIKE wildcard. Research.md SQL queries are the canonical implementation. See CHK016.
- [x] CHK026 - Is the `warpdl stop` behavior for recurring schedules consistent between contracts ("cancels ALL future occurrences") and the spec (FR-008 only says "cancel a scheduled download before it starts")? — **Verified consistent.** FR-008 explicitly says "permanently cancels the entire recurring schedule (all future executions)." Contracts and spec are aligned.

## Acceptance Criteria Quality

- [x] CHK027 - Can SC-001 ("within 60 seconds") be objectively measured in automated tests without flakiness from CI timing jitter? — **Yes.** Test with short schedule (5s in future), assert trigger occurred within generous bounds. Tests verify trigger happened, not exact timing. Mock `time.AfterFunc` for unit tests.
- [x] CHK028 - Can SC-002 ("100% of persisted schedules restored") be verified without exhaustive enumeration — is the expected set of schedule states defined? — **Yes.** Test: create items with all 5 ScheduleState values, GOB round-trip, assert all fields match. Exhaustive over the bounded enum.
- [x] CHK029 - Can SC-004 ("auto-detection works correctly on both macOS and Linux") be verified in CI — are macOS and Linux both CI targets? — **Yes.** CI runs on Ubuntu + macOS. Tests use mock fixtures (synthetic `cookies.sqlite` + `profiles.ini` in temp dir) — no real browser install needed.
- [x] CHK030 - Is SC-005 ("no more than 2 seconds for 10,000 cookies") measurable with a specific test methodology — cold start vs warm, what hardware baseline? — **Defined.** Benchmark test: generate 10k-row SQLite fixture, time `ImportCookies()`, assert < 2s. Cold start (no cache). Standard GitHub Actions runner hardware.
- [x] CHK031 - Are acceptance scenarios for User Story 6 (recurring) sufficient — is there a scenario for cron expression that fires during daemon downtime? — **Covered by FR-006 + scheduler design.** Missed-schedule detection on startup is specified. Test: schedule cron, simulate daemon restart after missed time, assert download starts.
- [x] CHK032 - Are acceptance scenarios for User Story 7 (speed limits) sufficient — is there a scenario for overlapping time ranges or invalid format? — **Deferred (P3).** Speed limit scheduling depends on bandwidth throttling. No design work in current plan.

## Security & Privacy Coverage

- [x] CHK033 - Is FR-020 ("MUST NOT log or display actual cookie values") specific enough — does "display" include debug mode, error messages containing cookie headers, or crash dumps? — **Clarified.** "MUST NOT display" applies to ALL output: normal, debug, error, and crash dumps. Cookie values are never formatted into strings. Only names + domains appear in logs at DEBUG level only.
- [x] CHK034 - Are requirements defined for sanitizing cookie values from HTTP request/response logs that may exist elsewhere in the codebase (e.g., debug mode logging in `pkg/logger/`)? — **Resolved.** Implementation must redact `Cookie` and `Set-Cookie` headers in debug logging (`Item.Headers` → `"[REDACTED]"` for cookie header values). Documented in plan.
- [x] CHK035 - Is FR-023 ("cookies held in-memory only") specific enough — are requirements defined for ensuring cookie values are not captured in core dumps, swap files, or Go heap profiles? — **Accepted risk.** Go doesn't expose heap contents in standard crash output. Core dumps are an OS-level concern. Cookies are inherently in-memory in every HTTP client — this is not a WarpDL-specific risk.
- [x] CHK036 - Are requirements defined for what happens when the cookie source path points to a file outside the user's home directory (e.g., `/etc/passwd`, symlink attacks)? — **No restriction.** Users may legitimately have cookie files in non-standard locations. The user invoked the command — they own the risk. Symlinks followed via standard `os.Open`.
- [x] CHK037 - Is the temp file cleanup requirement specified — when the SQLite copy is made to temp, are requirements defined for secure deletion (especially on failure paths)? — **Resolved.** `defer os.RemoveAll(tempDir)` immediately after creation. Cleanup runs on all paths (success, error, panic). Standard Go idiom. Documented in data-model cookie import flow.
- [x] CHK038 - Are requirements defined for preventing the `CookieSourcePath` from being exposed in `warpdl list` output to other users on shared systems? — **Resolved.** `warpdl list` shows browser name only (e.g., "Firefox"), not full path. Full path visible only in debug mode (`--debug`). GOB file is user-owned (`~/.config/warpdl/`, 0600 perms).
- [x] CHK039 - Is the scope of "names and domains only for debugging" (FR-020) defined — does this apply to all log levels or only debug mode? — **DEBUG level only.** Cookie names/domains logged only with `--debug`/`-d` flag. No cookie information at any other log level.
- [x] CHK040 - Are requirements defined for what happens when a Netscape cookie file contains cookies for domains the user did not intend to share (i.e., overly broad import from a full export)? Is there a confirmation or dry-run mode? — **Covered by FR-017.** Domain filtering is the safety mechanism — cookies for non-matching domains are silently skipped. `"Imported N cookies for {domain}"` tells the user exactly what was applied. No dry-run mode needed.

## Cross-Platform Coverage

- [x] CHK041 - Are Windows browser cookie paths specified in the same detail as macOS and Linux? Research.md covers macOS/Linux but Windows paths are absent. — **Already resolved.** Research.md §4 now includes Windows paths for all browsers (`%APPDATA%`, `%LOCALAPPDATA%`).
- [x] CHK042 - Are requirements defined for Windows support of `--cookies-from auto` auto-detection? The spec mentions platform-specific paths (FR-022) but Windows is only implied. — **Covered.** Windows auto-detection follows same priority order using `os.Getenv("LOCALAPPDATA")` and `os.Getenv("APPDATA")`. Build-tag isolated in `paths_windows.go`.
- [x] CHK043 - Is the Firefox Snap path (`~/snap/firefox/common/.mozilla/`) included in auto-detection requirements or only in research? — **Covered in research.md §4.** Implementation includes Snap path as fallback after standard `~/.mozilla/firefox/` in `paths_unix.go`.
- [x] CHK044 - Is the Chrome `Network/Cookies` migration path (v96+) documented as a requirement, or is it only an implementation detail in research? — **Covered in research.md §4.** Implementation checks both `Default/Cookies` and `Default/Network/Cookies`, preferring the newer path if both exist.
- [x] CHK045 - Are requirements defined for the Brave browser in auto-detection? Research lists it but spec's User Story 5 and FR-016 do not mention it. — **No gap.** Brave is in the canonical priority order (research.md §4). FR-016 says "documented priority order" — the documentation is research.md. Spec updated to reference full list.
- [x] CHK046 - Is the Windows named pipe behavior specified for scheduled download notifications? The spec doesn't address how scheduled-download status updates reach Windows CLI clients. — **No new IPC needed.** Scheduled downloads use existing download flow once triggered. Progress updates already broadcast via connection pool over named pipes on Windows. Scheduler just triggers an enqueue.
- [x] CHK047 - Are requirements defined for how `--start-at` behaves across DST transitions on Windows (where Go's time zone handling differs from Unix)? — **No special handling needed.** Go's `time.Parse` with `time.Local` handles DST on all platforms. Ambiguous times (fall-back DST) resolve to first occurrence — Go's `time.Parse` default. Documented in plan.
- [x] CHK048 - Is the Chromium-based browser cookie path resolution specified for Flatpak/AppImage installations on Linux? — **Deferred.** Flatpak/AppImage use non-standard paths varying by distro. Users with these installations should use explicit `--cookies-from <path>` or Netscape export. Not worth the complexity for a niche case.

## Edge Case & Error Handling Coverage

- [x] CHK049 - Is the behavior specified when the cookie SQLite file exists but is zero bytes or truncated? — **Resolved.** SQLite driver error caught. Report: `"error: cookie file at {path} is empty or corrupted"`. Documented in contracts error table.
- [x] CHK050 - Are requirements defined for handling the WAL file being present but the main SQLite file missing or corrupted? — **Resolved.** If main file missing, `os.Stat` fails first. If corrupted, driver returns error. Same handling as CHK049.
- [x] CHK051 - Is the behavior specified when `--start-in 0s` or `--start-in 0m` is provided (zero delay)? — **Valid input.** Resolves to "now" — starts immediately. Equivalent to no scheduling flag. No warning needed. Documented in contracts and FR-002.
- [x] CHK052 - Is the behavior specified when a cron expression resolves to "never fires" (e.g., February 30th: `0 0 30 2 *`)? — **Resolved.** If no next occurrence within 1 year, warn: `"warning: cron expression '{expr}' has no occurrence in the next year"`. Documented in contracts error table.
- [x] CHK053 - Are requirements defined for handling disk full conditions during the temp-file copy of a cookie database? — **Resolved.** `io.Copy` returns error. Report: `"error: failed to copy cookie database: {err}"`. Standard error handling. Documented in contracts.
- [x] CHK054 - Is the behavior specified when the download URL changes between cron occurrences (e.g., URL now returns 301 redirect)? — **No special handling.** WarpDL already follows redirects. Normal download behavior applies to each occurrence independently.
- [x] CHK055 - Is the behavior specified when `--cookies-from auto` succeeds but the found cookie store is for an older browser version with a different schema? — **Resolved.** SQLite query fails with "no such table"/"no such column." Report: `"error: unsupported cookie database schema at {path}"`. Documented in contracts.
- [x] CHK056 - Are requirements defined for the maximum length of a cron expression or `--start-at` value to prevent abuse? — **No explicit limit needed.** `gronx.IsValid()` rejects malformed expressions. `time.Parse` rejects malformed dates. WarpDL is single-user — no abuse vector. Go string limits are sufficient.
- [x] CHK057 - Is the behavior specified when the daemon receives a `--start-at` time that is valid but represents an ambiguous local time (e.g., during fall-back DST when 1:30 AM occurs twice)? — **Resolved.** Go's `time.Parse` with `time.Local` returns the first occurrence of the ambiguous time. Deterministic and consistent. Documented in plan and research.md §5.
- [x] CHK058 - Is the behavior specified when `--cookies-from` points to a cookie file that is a symlink to another file? — **Follow symlinks.** Standard `os.Open` behavior. No symlink detection or rejection. Same rationale as CHK036 — trust the user.
- [x] CHK059 - Are requirements defined for handling concurrent `warpdl download --schedule` commands that create overlapping recurring schedules for the same URL? — **Allowed.** Each command creates a new Item with its own hash. Two recurring schedules for the same URL produce independent download streams with different timestamp suffixes. Queue handles concurrency.
- [x] CHK060 - Is the behavior specified when a Netscape cookie file uses CRLF line endings vs LF? — **Handled.** `bufio.Scanner` with default `ScanLines` handles both `\n` and `\r\n`. No special handling needed.

## Dependencies & Assumptions

- [x] CHK061 - Is the assumption that "GOB zero-initializes missing fields" validated against the actual Go GOB specification — are all new field types zero-safe? — **Validated.** Go's `encoding/gob` spec confirms absent fields are zero-initialized. All new fields are value types (`time.Time`, `string`), not pointers — safe from golang/go#11119 pointer-skipping. Existing WarpDL pattern confirmed (Protocol, SSHKeyPath added without migration).
- [x] CHK062 - Is the assumption that "Firefox cookies are stored unencrypted" validated for all Firefox versions currently in the wild (ESR, Developer Edition, Nightly)? — **Validated.** Firefox stores cookies unencrypted across ALL variants: Release, ESR, Beta, Developer Edition, Nightly, LibreWolf. Mozilla has never implemented application-level cookie encryption (Bugzilla #1331238). Documented in research.md §3.
- [x] CHK063 - Is the dependency on queue manager (#135) explicitly bounded — what specific queue interface does the scheduler depend on, and is that interface stable? — **No interface dependency.** Scheduler calls the same `Download()` function that CLI uses. Queue is internal to warplib. Scheduler doesn't depend on queue manager interface at all.
- [x] CHK064 - Is the assumption that `modernc.org/sqlite` handles WAL mode correctly validated with a specific test case or reference? — **Validated.** Using `?immutable=1` URI parameter bypasses WAL entirely. WAL checkpoint handled by copying WAL file alongside main database before opening. Standard practice used by all cookie extraction tools.
- [x] CHK065 - Is the bandwidth throttling capability (required by User Story 7) documented as a prerequisite — does it exist today or is it assumed to be built? — **Deferred (P3).** Does NOT exist today. Explicitly noted in spec §Assumptions. Speed limit scheduling is out of scope for this plan.
- [x] CHK066 - Is the assumption that `adhocore/gronx` correctly handles DST transitions documented and validated? — **Validated.** gronx delegates to Go's `time` package. Spring-forward: `time.Date` normalizes nonexistent times. Fall-back: first occurrence used. Same behavior as standard crontab. Documented in research.md §5.

## Ambiguities & Conflicts

- [x] CHK067 - The spec says Chrome encrypted cookies are "out of scope" but FR-014 says "MUST support Chrome cookie stores when unencrypted." Is it specified what percentage of real-world Chrome installations have unencrypted cookies, and is the feature practically useful? — **Clarified.** Chrome parser serves: (1) Windows (DPAPI encryption is a different story — future work), (2) Chromium builds without encryption, (3) Netscape export fallback is documented recommendation for Chrome users on macOS/Linux. The feature is useful via Netscape format even when Chrome SQLite is encrypted.
- [x] CHK068 - The spec defines `ScheduleState` as an enum with 5 values but does not specify transitions from "missed" — can "missed" transition to "cancelled"? — **No.** "Missed" → "triggered" only. Missed downloads are enqueued immediately on daemon restart — they transition to "triggered" before a user could cancel. If user runs `warpdl stop` after download starts, it follows normal stop flow. State machine documented in data-model.md.
- [x] CHK069 - FR-024 says "persist the cookie source path" and FR-023 says "MUST NOT persist cookie values." Is it specified whether the cookie source path counts as sensitive data (it reveals the user's browser choice and profile path)? — **Acceptable risk.** Single-user daemon. GOB file is user-owned (`~/.config/warpdl/`, 0600 perms). `warpdl list` shows browser name only (not full path) per CHK038. Path visible only in debug mode.
- [x] CHK070 - The spec mentions `--cookies-from auto` uses "first valid cookie store found" but does not specify whether to prefer unencrypted stores (Firefox) over encrypted ones (Chrome) — is the priority order a requirement or an implementation detail? — **It IS a requirement.** Priority order (FR-016 "documented priority order") intentionally places Firefox and LibreWolf (unencrypted) before Chrome and derivatives (encrypted). This is by design, documented in research.md §4.

## Summary

| Category | Total | Resolved | Deferred (P3) |
|----------|-------|----------|---------------|
| Completeness | 12 | 11 | 1 (CHK009) |
| Clarity | 8 | 8 | 0 |
| Consistency | 6 | 6 | 0 |
| Acceptance Criteria | 6 | 5 | 1 (CHK032) |
| Security & Privacy | 8 | 8 | 0 |
| Cross-Platform | 8 | 7 | 1 (CHK048) |
| Edge Cases | 12 | 12 | 0 |
| Dependencies | 6 | 5 | 1 (CHK065) |
| Ambiguities | 4 | 4 | 0 |
| **Total** | **70** | **66** | **4** |

All 4 deferred items are P3 (speed limit scheduling) or niche edge cases (Flatpak/AppImage). No blocking items remain for P1/P2 implementation.

## Notes

- Existing `requirements.md` checklist was a lightweight pre-planning gate. This checklist audits the full artifact set (spec + plan + data-model + contracts + research) at PR-review depth.
- Items tagged `[Gap]` have been resolved with design decisions documented in plan.md's Audit Response Matrix.
- Items tagged `[Consistency]` have been reconciled — spec.md updated with 4 addenda (FR-002, FR-007, FR-009, User Story 5).
- Windows browser paths confirmed present in research.md §4 (previously flagged as absent).
- All spec addenda applied: FR-007 simplified (no prompt), FR-009 extended (schedule + start-at combo), FR-002 clarified (duration format), User Story 5 browser list canonicalized.
