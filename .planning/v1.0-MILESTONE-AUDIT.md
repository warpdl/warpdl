---
milestone: v1.0
audited: 2026-02-27
status: gaps_found
scores:
  requirements: 36/36
  phases: 8/8
  integration: 34/35
  flows: 7/8
gaps:
  requirements:
    - id: "RPC-06"
      status: "partial"
      phase: "Phase 6"
      claimed_by_plans: ["06-02-PLAN.md"]
      completed_by_plans: ["06-02-SUMMARY.md"]
      verification_status: "passed (HTTP path only)"
      evidence: "RPC download.resume wires handlers in rpc_methods.go:288-310, but Item.Resume() at item.go:283 passes nil handlers to ProtocolDownloader.Resume(). FTP/SFTP Resume methods use the handlers parameter directly — nil means no progress/complete notifications. HTTP resume is unaffected (patchHandlers installs callbacks on *Downloader struct field)."
    - id: "RPC-11"
      status: "partial"
      phase: "Phase 6, Phase 8"
      claimed_by_plans: ["06-02-PLAN.md", "08-01-PLAN.md"]
      completed_by_plans: ["06-02-SUMMARY.md", "08-01-SUMMARY.md"]
      verification_status: "passed (download.add fixed by Phase 8; resume still broken for FTP/SFTP)"
      evidence: "Phase 8 fixed download.add FTP/SFTP notifications (opts.Handlers now passed at lines 242 and 259). But download.resume for FTP/SFTP still drops notifications because Item.Resume() passes nil to ProtocolDownloader.Resume()."
  integration:
    - id: "INT-02"
      description: "RPC download.resume FTP/SFTP: Item.Resume() passes nil handlers to ProtocolDownloader.Resume() — no WebSocket push notifications for FTP/SFTP downloads resumed via JSON-RPC"
      from: "Phase 6 (rpc_methods.go:downloadResume line 329)"
      to: "Phase 3/4 (ftpProtocolDownloader.Resume / sftpProtocolDownloader.Resume)"
      affected_requirements: ["RPC-06", "RPC-11"]
      severity: "non-critical"
      reason: "downloadResume builds resumeOpts.Handlers with notifier closures (lines 288-310). manager.ResumeDownload calls patchProtocolHandlers(opts.Handlers, item) which wraps the handlers in-place. But Item.Resume() at item.go:283 calls d.Resume(ctx, parts, nil) — passing nil instead of the patched handlers. FTP/SFTP Resume methods use the handlers parameter directly, so all notifications are silently dropped."
      workaround: "CLI resume path works correctly (api/resume.go calls resumeItem which uses HTTP-specific patchHandlers). RPC download.add for FTP/SFTP works correctly (Phase 8 fix). Only RPC download.resume for FTP/SFTP is affected."
  flows:
    - flow: "RPC download.resume FTP/SFTP → WebSocket push notifications"
      breaks_at: "item.go:283 — Item.Resume() passes nil handlers to ProtocolDownloader.Resume()"
      affected_requirements: ["RPC-06", "RPC-11"]
      severity: "non-critical"
tech_debt:
  - phase: 05-json-rpc-20
    items:
      - "INT-01 (RESOLVED by Phase 8): RPC download.add FTP/SFTP handler nil-pass — now fixed with opts.Handlers passed at rpc_methods.go:242 and 259"
  - phase: 06-fix-integration-defects
    items:
      - "INT-02: RPC download.resume FTP/SFTP path — Item.Resume() passes nil handlers to ProtocolDownloader.Resume(), dropping WebSocket notifications and progress tracking"
  - phase: documentation
    items:
      - "6 SUMMARY files missing requirements-completed frontmatter: 02-01, 02-02, 04-01, 04-02, 04-03, 06-01 (PROTO-01, PROTO-03, SFTP-04, SFTP-06, RPC-06, RPC-11 not in any SUMMARY frontmatter)"
---

# v1.0 Milestone Audit Report

## Executive Summary

**Status: gaps_found** — 36/36 requirements satisfied in VERIFICATION and REQUIREMENTS.md. 1 integration defect found: FTP/SFTP resume via RPC drops WebSocket notifications because `Item.Resume()` passes `nil` handlers to `ProtocolDownloader.Resume()`. This partially affects RPC-06 and RPC-11 for the FTP/SFTP resume path only.

**Previous audit (INT-01):** RESOLVED by Phase 8 — `download.add` FTP/SFTP now correctly passes `opts.Handlers`.

**New finding (INT-02):** `download.resume` FTP/SFTP path has the same class of defect in a different location.

All 8 phases have VERIFICATION.md files showing PASS. REQUIREMENTS.md traceability shows 36/36 Complete.

## Scores

| Category | Score | Details |
|----------|-------|---------|
| Requirements | 36/36 | All v1 requirements verified in VERIFICATION.md and REQUIREMENTS.md |
| Phases | 8/8 | All phases complete with PASS verification |
| Integration | 34/35 | 1 defect: Item.Resume() nil handler pass for FTP/SFTP via RPC |
| E2E Flows | 7/8 | RPC download.resume for FTP/SFTP lacks push notifications |

## Requirements 3-Source Cross-Reference

All 36 requirements verified against 3 independent sources:
1. **VERIFICATION.md** — Phase-level verification with evidence
2. **SUMMARY.md frontmatter** — `requirements-completed` YAML field
3. **REQUIREMENTS.md traceability** — Status column + checkbox

| REQ-ID | VERIFICATION | SUMMARY Frontmatter | Traceability | Final Status |
|--------|-------------|---------------------|-------------|--------------|
| REDIR-01 | Phase 1: PASS | 01-01, 07-02 | Complete [x] | **satisfied** |
| REDIR-02 | Phase 1: PASS | 01-01, 07-02 | Complete [x] | **satisfied** |
| REDIR-03 | Phase 1: PASS | 01-01, 07-02 | Complete [x] | **satisfied** |
| REDIR-04 | Phase 1+6: PASS | 01-02 | Complete [x] | **satisfied** |
| PROTO-01 | Phase 2: PASS | *missing* | Complete [x] | **partial** (SUMMARY gap) |
| PROTO-02 | Phase 2: PASS | 07-02 | Complete [x] | **satisfied** |
| PROTO-03 | Phase 2: PASS | *missing* | Complete [x] | **partial** (SUMMARY gap) |
| FTP-01 | Phase 3: PASS | 03-01, 07-02 | Complete [x] | **satisfied** |
| FTP-02 | Phase 3: PASS | 03-01, 07-02 | Complete [x] | **satisfied** |
| FTP-03 | Phase 3: PASS | 03-01, 07-02 | Complete [x] | **satisfied** |
| FTP-04 | Phase 3: PASS | 03-01, 07-02 | Complete [x] | **satisfied** |
| FTP-05 | Phase 3: PASS | 03-01, 07-02 | Complete [x] | **satisfied** |
| FTP-06 | Phase 3: PASS | 03-01, 03-02, 07-02 | Complete [x] | **satisfied** |
| FTP-07 | Phase 3: PASS | 03-01, 03-02, 07-02 | Complete [x] | **satisfied** |
| FTP-08 | Phase 3: PASS | 03-01, 07-02 | Complete [x] | **satisfied** |
| SFTP-01 | Phase 4: PASS | 07-02 | Complete [x] | **satisfied** |
| SFTP-02 | Phase 4: PASS | 07-02 | Complete [x] | **satisfied** |
| SFTP-03 | Phase 4: PASS | 07-02 | Complete [x] | **satisfied** |
| SFTP-04 | Phase 4+6: PASS | *missing* | Complete [x] | **partial** (SUMMARY gap) |
| SFTP-05 | Phase 4: PASS | 07-02 | Complete [x] | **satisfied** |
| SFTP-06 | Phase 4+6: PASS | *missing* | Complete [x] | **partial** (SUMMARY gap) |
| SFTP-07 | Phase 4: PASS | 07-02 | Complete [x] | **satisfied** |
| SFTP-08 | Phase 4: PASS | 07-02 | Complete [x] | **satisfied** |
| SFTP-09 | Phase 4: PASS | 07-02 | Complete [x] | **satisfied** |
| RPC-01 | Phase 5: PASS | 07-02 | Complete [x] | **satisfied** |
| RPC-02 | Phase 5: PASS | 07-02 | Complete [x] | **satisfied** |
| RPC-03 | Phase 5: PASS | 07-02 | Complete [x] | **satisfied** |
| RPC-04 | Phase 5: PASS | 07-02 | Complete [x] | **satisfied** |
| RPC-05 | Phase 5+8: PASS | 07-02 | Complete [x] | **satisfied** |
| RPC-06 | Phase 5+6: PASS | *missing* | Complete [x] | **partial** (SUMMARY gap + INT-02 defect) |
| RPC-07 | Phase 5: PASS | 07-02 | Complete [x] | **satisfied** |
| RPC-08 | Phase 5: PASS | 07-02 | Complete [x] | **satisfied** |
| RPC-09 | Phase 5: PASS | 07-02 | Complete [x] | **satisfied** |
| RPC-10 | Phase 5: PASS | 07-02 | Complete [x] | **satisfied** |
| RPC-11 | Phase 5+6+8: PASS | *missing* | Complete [x] | **partial** (SUMMARY gap + INT-02 defect) |
| RPC-12 | Phase 5: PASS | 07-02 | Complete [x] | **satisfied** |

**Orphaned requirements:** 0 — every requirement in the traceability table appears in at least one VERIFICATION.md
**Unsatisfied requirements:** 0
**Partial requirements:** 6 (PROTO-01, PROTO-03: SUMMARY frontmatter gap only; SFTP-04, SFTP-06: SUMMARY frontmatter gap only; RPC-06, RPC-11: SUMMARY frontmatter gap + INT-02 code defect)

## Phase Verification Summary

| Phase | Result | Requirements Verified | Notes |
|-------|--------|----------------------|-------|
| 1. HTTP Redirect | PASS | REDIR-01, REDIR-02, REDIR-03, REDIR-04 | Defense-in-depth across 6+ call sites |
| 2. Protocol Interface | PASS | PROTO-01, PROTO-02, PROTO-03 | Re-verified after Phase 3/4; all gaps resolved |
| 3. FTP/FTPS | PASS | FTP-01 through FTP-08 | 48+ test cases with mock FTP server |
| 4. SFTP | PASS | SFTP-01 through SFTP-09 | 50+ tests; SSHKeyPath persistence fixed in Phase 6 |
| 5. JSON-RPC 2.0 | PASS | RPC-01 through RPC-12 | 14 E2E integration tests; resume notifications fixed in Phase 6 |
| 6. Fix Integration Defects | PASS | SFTP-04, SFTP-06, RPC-06, RPC-11, REDIR-04 | 3 defects fixed with 8 new tests |
| 7. Verification & Doc Closure | PASS | 29 requirements re-verified | Documentation-only, no code changes |
| 8. Fix RPC FTP/SFTP Handlers | PASS | RPC-05, RPC-11 | download.add FTP/SFTP handler nil-pass fixed (INT-01 resolved) |

## Integration Check Results

**Cross-phase wiring:** 34/35 connections verified

### Resolved: INT-01 — RPC download.add FTP/SFTP handler nil-pass

**Status: FIXED by Phase 8**
**File:** `internal/server/rpc_methods.go`, lines 242 and 259
**Fix:** `nil` replaced with `opts.Handlers` in both `AddProtocolDownload` call and `pd.Download` call.
Verified: `opts.Handlers` (populated with notifier closures at lines 170-191) is now correctly passed to both the manager and the downloader. FTP/SFTP downloads started via `download.add` emit WebSocket push notifications and persist item progress.

### NEW: INT-02 — RPC download.resume FTP/SFTP notification drop

**File:** `pkg/warplib/item.go:283` and `internal/server/rpc_methods.go:329`
**Issue:** `downloadResume` builds `resumeOpts.Handlers` with notifier closures (lines 288-310). `manager.ResumeDownload` calls `patchProtocolHandlers(opts.Handlers, item)` at line 613, which wraps the handlers in-place. But `downloadResume` then calls `go resumedItem.Resume()` (line 329), and `Item.Resume()` at `item.go:283` calls `d.Resume(context.Background(), partsCopy, nil)` — passing `nil` handlers. FTP/SFTP `Resume` methods use the `handlers` parameter directly for progress/complete callbacks, so all WebSocket notifications are silently dropped.
**Root cause:** `Item.Resume()` was designed for HTTP items where `patchHandlers` installs callbacks on `*Downloader.handlers` (a struct field retained on the downloader). For FTP/SFTP items, `patchProtocolHandlers` wraps an external `*Handlers` pointer that is NOT stored on the protocol downloader struct — it's discarded when `ResumeDownload` returns.
**Impact:** Non-critical. Only affects FTP/SFTP downloads resumed via JSON-RPC `download.resume`. The CLI resume path and RPC `download.add` path are unaffected.
**Affected requirements:** RPC-06 (partial), RPC-11 (partial)
**Fix:** Either store `handlers` on `sftpProtocolDownloader`/`ftpProtocolDownloader` structs (set during `patchProtocolHandlers`), or modify `Item.Resume()` to accept and pass through a `handlers` parameter.

### E2E Flow Verification

| Flow | Status | Details |
|------|--------|---------|
| HTTP download with redirects | COMPLETE | CLI -> daemon -> API -> warplib -> redirect resolution -> parallel segments use final URL |
| FTP download (CLI) | COMPLETE | CLI -> SchemeRouter -> FTP downloader -> single-stream download with progress |
| SFTP download (CLI) | COMPLETE | CLI -> SchemeRouter -> SFTP downloader -> TOFU -> download with key/password auth |
| SFTP resume custom key | COMPLETE | Item.SSHKeyPath persisted via GOB -> threaded through resume -> SSH auth succeeds |
| RPC download.add HTTP | COMPLETE | JSON-RPC -> auth -> download -> WebSocket push notifications |
| RPC download.add FTP/SFTP | COMPLETE | JSON-RPC -> auth -> SchemeRouter -> FTP/SFTP download -> WebSocket push (Phase 8 fix) |
| RPC download.resume HTTP | COMPLETE | JSON-RPC -> handlers wired -> manager.ResumeDownload -> patchHandlers -> notifications |
| **RPC download.resume FTP/SFTP** | **BROKEN** | Handlers wired in rpc_methods.go but Item.Resume() passes nil to ProtocolDownloader.Resume() |
| GOB backward compat | COMPLETE | Pre-Phase-2 items load correctly; Protocol zero-value = HTTP; SSHKeyPath zero-value = "" |
| web.go redirect policy | COMPLETE | processDownload creates http.Client with explicit CheckRedirect |

## Tech Debt

### Phase 5: JSON-RPC 2.0
- **INT-01 (RESOLVED):** RPC download.add FTP/SFTP handler nil-pass — fixed by Phase 8 (opts.Handlers now passed at lines 242, 259)

### Phase 6: Fix Integration Defects
- **INT-02 (NEW):** RPC download.resume FTP/SFTP — Item.Resume() passes nil handlers to ProtocolDownloader.Resume(), dropping WebSocket notifications and progress tracking for FTP/SFTP items resumed via RPC

### Documentation
- 6 SUMMARY files missing `requirements-completed` frontmatter (02-01, 02-02, 04-01, 04-02, 04-03, 06-01) — affects PROTO-01, PROTO-03, SFTP-04, SFTP-06, RPC-06, RPC-11 cross-reference

### Total: 1 code defect + 1 documentation gap (previous INT-01 resolved)

---
*Audited: 2026-02-27*
*Auditor: Claude (audit-milestone workflow)*
*Previous audit: 2026-02-27 (status: tech_debt — INT-01 now resolved by Phase 8)*
*This audit: Phase 8 verified, INT-01 closed, INT-02 discovered*
