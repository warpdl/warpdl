---
phase: 01-http-redirect
plan: 02
type: tdd
wave: 2
depends_on: [01-01]
files_modified:
  - pkg/warplib/redirect.go
  - pkg/warplib/redirect_test.go
  - cmd/daemon_core.go
  - cmd/info.go
  - pkg/warplib/proxy.go
autonomous: true
requirements: [REDIR-04]

must_haves:
  truths:
    - "Authorization header is NOT forwarded when redirect crosses to a different origin (different host)"
    - "Custom user headers (e.g. --header) are stripped on cross-origin redirect except User-Agent and Accept"
    - "Cookies follow Go's default domain-scoped behavior (no cross-origin leak)"
    - "All HTTP client creation sites use the redirect policy"
  artifacts:
    - path: "pkg/warplib/redirect_test.go"
      provides: "Regression tests for CVE-2024-45336 Authorization header leak, custom header stripping"
    - path: "pkg/warplib/redirect.go"
      provides: "Updated RedirectPolicy with cross-origin header stripping"
  key_links:
    - from: "cmd/daemon_core.go"
      to: "pkg/warplib/redirect.go:RedirectPolicy"
      via: "HTTP client creation sets CheckRedirect"
      pattern: "CheckRedirect.*RedirectPolicy"
    - from: "cmd/info.go"
      to: "pkg/warplib/redirect.go:RedirectPolicy"
      via: "HTTP client creation sets CheckRedirect"
      pattern: "CheckRedirect.*RedirectPolicy"
    - from: "pkg/warplib/proxy.go"
      to: "pkg/warplib/redirect.go:RedirectPolicy"
      via: "Proxy client creation sets CheckRedirect"
      pattern: "CheckRedirect.*RedirectPolicy"
---

<objective>
Add cross-origin header stripping on redirect and regression tests for CVE-2024-45336.

Purpose: REDIR-04 requires that Authorization headers are not leaked across cross-origin redirects. Go 1.24+ already handles this for the Authorization header specifically, but we need: (1) regression tests that explicitly verify this behavior, (2) custom header stripping for user-provided headers on cross-origin redirect, and (3) all HTTP client creation sites configured with RedirectPolicy.

Output: Updated redirect.go with header stripping, regression tests, and all client creation sites using the policy.
</objective>

<execution_context>
@/Users/divkix/.claude/get-shit-done/workflows/execute-plan.md
@/Users/divkix/.claude/get-shit-done/templates/summary.md
@/Users/divkix/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/01-http-redirect/01-RESEARCH.md
@.planning/phases/01-http-redirect/01-01-SUMMARY.md

@pkg/warplib/redirect.go
@pkg/warplib/redirect_test.go
@pkg/warplib/dloader.go
@cmd/daemon_core.go
@cmd/info.go
@pkg/warplib/proxy.go
</context>

<interfaces>
<!-- From Plan 01-01 output — will be created by prior plan -->

From pkg/warplib/redirect.go (created by Plan 01-01):
```go
const DefaultMaxRedirects = 10

var ErrTooManyRedirects = errors.New("redirect loop detected")
var ErrCrossProtocolRedirect = errors.New("cross-protocol redirect not supported")

// RedirectPolicy returns a CheckRedirect function.
// This plan extends it to also strip custom headers on cross-origin redirects.
func RedirectPolicy(maxRedirects int) func(*http.Request, []*http.Request) error
```

From cmd/daemon_core.go:
```go
// Line 109: client := &http.Client{Jar: jar}
// Must set CheckRedirect here
```

From cmd/info.go:
```go
// Line 51: httpClient = &http.Client{}
// Line 46: httpClient, err = warplib.NewHTTPClientWithProxy(proxyURL)
// Both need CheckRedirect
```

From pkg/warplib/proxy.go:
```go
// NewHTTPClientWithProxy creates client with proxy transport — needs CheckRedirect
func NewHTTPClientWithProxy(proxyURL string) (*http.Client, error)
// NewHTTPClientFromEnvironment creates client from env — needs CheckRedirect
func NewHTTPClientFromEnvironment() (*http.Client, error)
// NewHTTPClientWithProxyAndTimeout creates client with proxy + timeout — needs CheckRedirect
func NewHTTPClientWithProxyAndTimeout(proxyURL string, timeoutMs int) (*http.Client, error)
```
</interfaces>

<feature>
  <name>Cross-Origin Header Stripping and Client Configuration</name>
  <files>pkg/warplib/redirect.go, pkg/warplib/redirect_test.go, cmd/daemon_core.go, cmd/info.go, pkg/warplib/proxy.go</files>
  <behavior>
    Test cases:
    1. CVE-2024-45336 regression: Authorization header present on same-origin redirect, absent on cross-origin redirect
    2. Custom header (X-Custom-Token) present on same-origin redirect, absent on cross-origin redirect
    3. User-Agent header preserved on cross-origin redirect (safe header)
    4. Accept header preserved on cross-origin redirect (safe header)
    5. Multiple custom headers: all stripped on cross-origin, all preserved on same-origin
    6. Cross-origin with different port but same hostname: treated as same origin (host:port matching)
    7. Cross-origin with subdomain change (api.example.com -> cdn.example.com): headers stripped
    8. Cookie jar behavior: cookies are domain-scoped by default (Go stdlib), no custom code needed — verify with test

    Integration verification:
    9. daemon_core.go client has CheckRedirect set
    10. info.go client has CheckRedirect set
    11. proxy.go clients have CheckRedirect set
  </behavior>
  <implementation>
    1. Update RedirectPolicy in redirect.go:
       - Add header-stripping logic inside the CheckRedirect function
       - On cross-origin redirect (different host):
         - Strip all custom headers EXCEPT User-Agent and Accept
         - NOTE: Do NOT manually strip Authorization — Go 1.24+ handles this automatically
         - Cross-origin = different Host value (scheme://host:port format from URL.Host)
       - Define a safeHeaders set: {"User-Agent", "Accept", "Accept-Language", "Accept-Encoding"}
       - For cross-origin: iterate req.Header, delete anything not in safeHeaders and not managed by Go internally (Content-Type, Range, etc.)
       - Add a helper: isCrossOrigin(oldURL, newURL *url.URL) bool

    2. Add regression tests to redirect_test.go:
       - TestCVE2024_45336_AuthorizationLeak: httptest server that captures request headers on cross-origin redirect
       - TestCrossOriginCustomHeaderStripping: verify custom headers stripped, safe headers preserved
       - TestSameOriginHeaderPreservation: verify all headers kept on same-origin redirect
       - TestCrossOriginDefinition: table-driven tests for isCrossOrigin helper

    3. Update all HTTP client creation sites:
       - cmd/daemon_core.go: Set client.CheckRedirect = warplib.RedirectPolicy(warplib.DefaultMaxRedirects)
       - cmd/info.go: Set httpClient.CheckRedirect for both proxy and non-proxy paths
       - pkg/warplib/proxy.go: Set CheckRedirect on all three NewHTTPClient* functions
       - IMPORTANT: Plan 01-01 already sets CheckRedirect in NewDownloader as a fallback.
         The client-level setting here ensures it's applied even for code paths that
         bypass NewDownloader (like the web server in internal/server/web.go).

    4. Verify no regression:
       - Run full test suite
       - Ensure existing tests pass (they use bare &http.Client{} which NewDownloader now protects)
  </implementation>
</feature>

<verification>
```bash
go test -v -run "TestRedirect\|TestCVE\|TestCrossOrigin\|TestSameOrigin" ./pkg/warplib/ -count=1
go test -race -short ./...
go vet ./...
```
</verification>

<success_criteria>
- RED: Failing tests for cross-origin header stripping and CVE regression
- GREEN: Tests pass with header stripping implementation
- REFACTOR: Clean separation of concerns, isCrossOrigin helper extracted
- Authorization header NOT forwarded on cross-origin redirect (CVE-2024-45336 regression guard)
- Custom user headers stripped on cross-origin redirect
- Safe headers (User-Agent, Accept) preserved on cross-origin redirect
- All HTTP client creation sites (daemon_core.go, info.go, proxy.go) use RedirectPolicy
- All existing tests pass
- Coverage for pkg/warplib/ stays at or above 80%
</success_criteria>

<output>
After completion, create `.planning/phases/01-http-redirect/01-02-SUMMARY.md`
</output>
