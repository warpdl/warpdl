---
phase: 04-sftp
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - pkg/warplib/protocol_sftp.go
  - pkg/warplib/protocol_sftp_test.go
  - pkg/warplib/known_hosts.go
  - pkg/warplib/known_hosts_test.go
  - pkg/warplib/protocol_router.go
  - go.mod
  - go.sum
autonomous: true
requirements: [SFTP-01, SFTP-02, SFTP-03, SFTP-04, SFTP-05, SFTP-07, SFTP-08, SFTP-09]

must_haves:
  truths:
    - "sftpProtocolDownloader struct exists in protocol_sftp.go and satisfies ProtocolDownloader interface -- compile-time check via var _ ProtocolDownloader = (*sftpProtocolDownloader)(nil)"
    - "newSFTPProtocolDownloader factory parses sftp:// URLs, extracting host:port, path, credentials, and SSH key path"
    - "When credentials are in the URL (sftp://user:pass@host/path), factory extracts username and password correctly (SFTP-02)"
    - "When no password in URL, factory falls back to SSH private key auth from default paths ~/.ssh/id_ed25519, ~/.ssh/id_rsa (SFTP-03)"
    - "When opts.SSHKeyPath is set, factory uses that explicit key path (SFTP-04)"
    - "When no credentials or key, factory returns clear error: no authentication method available"
    - "Capabilities() returns {SupportsParallel: false, SupportsResume: true} (SFTP-05)"
    - "Probe() connects via SSH, opens SFTP subsystem, calls sftpClient.Stat(remotePath) for file size, then disconnects (SFTP-09)"
    - "Probe() returns ProbeResult with correct FileName (from path.Base), ContentLength (from Stat), Resumable=true, Checksums=nil"
    - "Download() connects fresh (does not reuse Probe connection), opens remote file, streams via io.Copy with progress writer"
    - "Download() calls handlers.SpawnPartHandler with single-part range [0, fileSize-1] (SFTP-05 single stream) -- nil-guarded"
    - "Download() calls handlers.DownloadCompleteHandler(MAIN_HASH, totalBytes) on success -- nil-guarded"
    - "Download() calls handlers.DownloadProgressHandler on each Write from sftpProgressWriter -- nil-guarded"
    - "StripURLCredentials removes userinfo from sftp:// URL: sftp://user:pass@host/path -> sftp://host/path (reuses existing function from protocol_ftp.go)"
    - "Default SFTP port is 22 when not specified in URL (SFTP-08)"
    - "Custom port in URL (sftp://user@host:2222/path) is correctly parsed and used (SFTP-08)"
    - "Factory rejects URLs with empty/root path (sftp://host/ or sftp://host) with descriptive error"
    - "newTOFUHostKeyCallback creates callback that auto-accepts unknown hosts and appends to ~/.config/warpdl/known_hosts (SFTP-07)"
    - "newTOFUHostKeyCallback rejects changed host keys with clear MITM warning error (SFTP-07)"
    - "newTOFUHostKeyCallback uses knownhosts.Normalize for correct port handling (port 22 omitted, non-22 bracketed) (SFTP-07)"
    - "known_hosts file writes are serialized via package-level sync.Mutex to prevent concurrent corruption"
    - "ssh.PassphraseMissingError from protected keys returns clear user-facing error, not panic"
    - "SchemeRouter has 'sftp' factory registered after NewSchemeRouter -- SupportedSchemes includes sftp"
    - "go.mod includes github.com/pkg/sftp v1.13.10 and golang.org/x/crypto v0.48.0 as direct dependencies"
  artifacts:
    - path: "pkg/warplib/protocol_sftp.go"
      provides: "sftpProtocolDownloader struct, newSFTPProtocolDownloader factory, Probe/Download methods, connect helper, classifySFTPError, buildAuthMethods, resolveSSHKeyPaths, sftpProgressWriter"
      exports: ["newSFTPProtocolDownloader"]
    - path: "pkg/warplib/known_hosts.go"
      provides: "newTOFUHostKeyCallback function, appendKnownHost helper, knownHostsMu mutex, KnownHostsPath variable"
      exports: ["KnownHostsPath"]
    - path: "pkg/warplib/known_hosts_test.go"
      provides: "Unit tests for TOFU callback: unknown host accept, known host pass, mismatch reject, concurrent writes, port normalization"
    - path: "pkg/warplib/protocol_sftp_test.go"
      provides: "Unit and integration tests using in-process SFTP mock server -- factory, auth, capabilities, probe, download, error classification, credential stripping, scheme routing"
    - path: "pkg/warplib/protocol_router.go"
      provides: "Updated NewSchemeRouter with sftp factory registration"
  key_links:
    - from: "pkg/warplib/protocol_sftp.go:sftpProtocolDownloader"
      to: "pkg/warplib/protocol.go:ProtocolDownloader"
      via: "Interface implementation"
      pattern: "var _ ProtocolDownloader = \\(\\*sftpProtocolDownloader\\)"
    - from: "pkg/warplib/protocol_router.go:NewSchemeRouter"
      to: "pkg/warplib/protocol_sftp.go:newSFTPProtocolDownloader"
      via: "sftp factory registered in SchemeRouter"
      pattern: "routes\\[\"sftp\"\\]"
    - from: "pkg/warplib/protocol_sftp.go:connect"
      to: "pkg/warplib/known_hosts.go:newTOFUHostKeyCallback"
      via: "SSH connection uses TOFU callback for host key verification"
      pattern: "newTOFUHostKeyCallback"
    - from: "pkg/warplib/protocol_sftp.go:buildAuthMethods"
      to: "golang.org/x/crypto/ssh:Password,PublicKeys,ParsePrivateKey"
      via: "Auth method selection: password from URL or SSH key from disk"
      pattern: "ssh\\.Password|ssh\\.PublicKeys"
---

<objective>
Implement the core SFTP downloader struct with single-stream download, password and SSH key auth, TOFU host key verification, custom port support, file size probing, and wire it into SchemeRouter.

Purpose: This is the foundational SFTP plan. It creates `sftpProtocolDownloader` implementing `ProtocolDownloader`, the TOFU known_hosts subsystem in `known_hosts.go`, registers the SFTP factory in `SchemeRouter`, and adds all dependencies (`pkg/sftp`, `x/crypto/ssh`). The mock SFTP server (in-process SSH + SFTP) provides realistic test coverage without network dependencies. Credential stripping ensures `sftp://user:pass@host/path` never persists credentials.

Output: protocol_sftp.go (downloader implementation), known_hosts.go (TOFU subsystem), protocol_sftp_test.go and known_hosts_test.go (comprehensive tests), updated protocol_router.go, updated go.mod/go.sum.
</objective>

<execution_context>
@/Users/divkix/.claude/get-shit-done/workflows/execute-plan.md
@/Users/divkix/.claude/get-shit-done/templates/summary.md
@/Users/divkix/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/04-sftp/04-RESEARCH.md

@pkg/warplib/protocol.go
@pkg/warplib/protocol_ftp.go
@pkg/warplib/protocol_router.go
@pkg/warplib/manager.go
@pkg/warplib/item.go
@pkg/warplib/handlers.go
@pkg/warplib/errors.go
@pkg/warplib/dloader.go
</context>

<interfaces>
<!-- Key types and contracts the executor needs. -->

From pkg/warplib/protocol.go -- interface the SFTP downloader must implement:
```go
type ProtocolDownloader interface {
    Probe(ctx context.Context) (ProbeResult, error)
    Download(ctx context.Context, handlers *Handlers) error
    Resume(ctx context.Context, parts map[int64]*ItemPart, handlers *Handlers) error
    Capabilities() DownloadCapabilities
    Close() error
    Stop()
    IsStopped() bool
    GetMaxConnections() int32
    GetMaxParts() int32
    GetHash() string
    GetFileName() string
    GetDownloadDirectory() string
    GetSavePath() string
    GetContentLength() ContentLength
}

type DownloadCapabilities struct {
    SupportsParallel bool
    SupportsResume   bool
}

type ProbeResult struct {
    FileName      string
    ContentLength int64
    Resumable     bool
    Checksums     []ExpectedChecksum
}

type DownloaderFactory func(rawURL string, opts *DownloaderOpts) (ProtocolDownloader, error)
```

From pkg/warplib/protocol_router.go -- registration point:
```go
type SchemeRouter struct {
    routes map[string]DownloaderFactory
}
func NewSchemeRouter(client *http.Client) *SchemeRouter  // add sftp here
func (r *SchemeRouter) Register(scheme string, factory DownloaderFactory)
```

From pkg/warplib/protocol_ftp.go -- existing pattern to mirror:
```go
type ftpProtocolDownloader struct {
    rawURL   string
    opts     *DownloaderOpts
    host     string    // host:port
    ftpPath  string    // file path on server
    user     string    // from URL userinfo -- NOT persisted
    password string    // from URL userinfo -- NOT persisted
    useTLS   bool      // true for ftps://
    fileName string    // path.Base of URL path
    fileSize int64     // set during Probe
    hash     string    // unique download ID
    dlDir    string    // download directory
    savePath string    // full save path
    probed   bool
    stopped  int32     // atomic
    cleanURL string    // URL with credentials stripped -- safe to persist
    ctx      context.Context
    cancel   context.CancelFunc
}

func StripURLCredentials(rawURL string) string  // reuse for SFTP
```

From pkg/warplib/dloader.go -- DownloaderOpts (existing, needs SSHKeyPath addition):
```go
type DownloaderOpts struct {
    ForceParts        bool
    FileName          string
    DownloadDirectory string
    MaxConnections    int32
    MaxSegments       int32
    Headers           Headers
    Handlers          *Handlers
    // ... other fields ...
}
// SFTP needs: add SSHKeyPath string field to DownloaderOpts
```

From github.com/pkg/sftp v1.13.10 -- library API:
```go
func NewClient(conn *ssh.Client, opts ...ClientOption) (*Client, error)
func (c *Client) Open(path string) (*File, error)
func (c *Client) Stat(path string) (os.FileInfo, error)
func (f *File) Seek(offset int64, whence int) (int64, error)
func (f *File) Read(b []byte) (int, error)
func (f *File) WriteTo(w io.Writer) (int64, error)
func (c *Client) Close() error
```

From golang.org/x/crypto/ssh -- SSH client API:
```go
type ClientConfig struct {
    User            string
    Auth            []AuthMethod
    HostKeyCallback HostKeyCallback
    Timeout         time.Duration
}
func Dial(network, addr string, config *ClientConfig) (*Client, error)
func Password(password string) AuthMethod
func PublicKeys(signers ...Signer) AuthMethod
func ParsePrivateKey(pemBytes []byte) (Signer, error)
type PassphraseMissingError struct { ... }
func FingerprintSHA256(key PublicKey) string
```

From golang.org/x/crypto/ssh/knownhosts:
```go
func New(files ...string) (ssh.HostKeyCallback, error)
func Normalize(address string) string  // "host:22" -> "host", "host:2222" -> "[host]:2222"
func Line(addresses []string, key ssh.PublicKey) string
type KeyError struct {
    Want []KnownKey  // len==0 means unknown host; len>0 means mismatch
}
```

From pkg/warplib/handlers.go -- key handler types SFTP must invoke:
```go
type Handlers struct {
    SpawnPartHandler        SpawnPartHandlerFunc        // (hash, ioff, foff)
    DownloadProgressHandler DownloadProgressHandlerFunc // (hash, nread)
    DownloadCompleteHandler DownloadCompleteHandlerFunc // (hash, tread)
    ErrorHandler            ErrorHandlerFunc            // (hash, err)
    DownloadStoppedHandler  DownloadStoppedHandlerFunc  // ()
    // SFTP does NOT use: RespawnPartHandler, CompileStartHandler, CompileProgressHandler, CompileCompleteHandler, WorkStealHandler
}
```
</interfaces>

<feature>
  <name>SFTP Protocol Downloader with TOFU Host Key Verification</name>
  <files>pkg/warplib/protocol_sftp.go, pkg/warplib/protocol_sftp_test.go, pkg/warplib/known_hosts.go, pkg/warplib/known_hosts_test.go, pkg/warplib/protocol_router.go, pkg/warplib/dloader.go, go.mod, go.sum</files>
  <behavior>
    Test cases for SFTP-01 (download from sftp:// URLs):
    1. newSFTPProtocolDownloader("sftp://testuser:testpass@localhost:2222/pub/file.iso", opts) creates downloader with correct host, path, fileName
    2. SchemeRouter.NewDownloader("sftp://testuser:testpass@localhost:2222/pub/file.iso", opts) dispatches to SFTP factory -- returned downloader is *sftpProtocolDownloader
    3. Full download against mock SFTP server: file written to disk, bytes match expected content

    Test cases for SFTP-02 (password auth via URL):
    4. newSFTPProtocolDownloader("sftp://testuser:testpass@host/file") extracts user="testuser", password="testpass"
    5. Probe() against mock SFTP server succeeds with password credentials
    6. Download() against mock SFTP server with password auth: file content matches

    Test cases for SFTP-03 (SSH private key auth default paths):
    7. When no password in URL, buildAuthMethods tries ~/.ssh/id_ed25519 then ~/.ssh/id_rsa
    8. Probe() with key auth against mock SFTP server succeeds (mock server configured to accept test key)

    Test cases for SFTP-04 (custom SSH key path):
    9. newSFTPProtocolDownloader with opts.SSHKeyPath="/custom/key" uses that path for auth
    10. buildAuthMethods with explicit keyPath returns auth from that key (not defaults)

    Test cases for SFTP-05 (single stream):
    11. Capabilities() returns {SupportsParallel: false, SupportsResume: true}
    12. Download calls SpawnPartHandler exactly once with range [0, fileSize-1]
    13. GetMaxConnections() returns 1
    14. GetMaxParts() returns 1

    Test cases for SFTP-07 (TOFU host key verification):
    15. newTOFUHostKeyCallback with non-existent known_hosts file: first connection to unknown host auto-accepts and appends to file
    16. newTOFUHostKeyCallback with existing known_hosts: known host key matches -> returns nil
    17. newTOFUHostKeyCallback with existing known_hosts: host key changed -> returns error with MITM warning
    18. newTOFUHostKeyCallback: concurrent TOFU appends from 2 goroutines do not corrupt file
    19. appendKnownHost with port 22 normalizes to "hostname" (not "[hostname]:22")
    20. appendKnownHost with port 2222 normalizes to "[hostname]:2222"
    21. newTOFUHostKeyCallback: after auto-accept, subsequent connection to same host succeeds via re-read of file
    22. known_hosts directory is auto-created if missing (~/.config/warpdl/ might not exist)

    Test cases for SFTP-08 (custom port):
    23. newSFTPProtocolDownloader("sftp://user@host:2222/file.iso") uses port 2222
    24. newSFTPProtocolDownloader("sftp://user:pass@host/file.iso") defaults to port 22
    25. SSH Dial uses the correct host:port from URL

    Test cases for SFTP-09 (file size before download):
    26. Probe() returns ProbeResult.ContentLength matching actual file size on mock server
    27. Probe() returns ProbeResult.FileName from path.Base of URL path
    28. Probe() returns Resumable=true, Checksums=nil

    Error classification:
    29. classifySFTPError with os.ErrNotExist returns permanent error
    30. classifySFTPError with net.OpError returns transient error
    31. classifySFTPError with nil returns nil
    32. classifySFTPError with *ssh.ExitError returns permanent error

    Factory edge cases:
    33. newSFTPProtocolDownloader("sftp://host/") returns error (empty filename from root path)
    34. newSFTPProtocolDownloader("sftp://host") returns error (no path)
    35. newSFTPProtocolDownloader("sftp://user@host/file.iso") without password: falls back to key auth
    36. Calling Download() without Probe() returns ErrProbeRequired
    37. Calling Resume() without Probe() returns ErrProbeRequired

    Auth edge cases:
    38. buildAuthMethods with passphrase-protected key returns clear error about unsupported passphrase keys
    39. buildAuthMethods with no password and no readable SSH key returns clear error

    Nil-handler safety:
    40. Download() with nil *Handlers does not panic -- completes download, file written correctly
    41. Download() with partial *Handlers (only DownloadProgressHandler set, others nil) does not panic

    Credential stripping (reuses existing StripURLCredentials):
    42. StripURLCredentials("sftp://user:pass@host:22/path/file.iso") returns "sftp://host:22/path/file.iso"
    43. StripURLCredentials("sftp://host/path") returns "sftp://host/path" (no-op)

    SchemeRouter:
    44. SupportedSchemes includes "sftp" after NewSchemeRouter
    45. SchemeRouter dispatches "SFTP://" (uppercase) correctly via case normalization

    DownloaderOpts:
    46. DownloaderOpts.SSHKeyPath field exists and is passed through to SFTP factory
  </behavior>
  <implementation>
    PHASE A: Add dependencies (go.mod)

    1. Run: cd /Users/divkix/GitHub/warpdl/.claude/worktrees/issues-fix && go get github.com/pkg/sftp@v1.13.10
    2. Run: go get golang.org/x/crypto@v0.48.0
    3. Run: go mod tidy

    NOTE: golang.org/x/crypto is currently at v0.47.0 (indirect via x/net). Phase 4 makes it a DIRECT dependency at v0.48.0. This also patches GO-2025-4134 (GSSAPI DoS) and GO-2025-4135 (agent OOB read).

    PHASE B: Add SSHKeyPath field to DownloaderOpts

    In pkg/warplib/dloader.go, add to DownloaderOpts struct:
    ```go
    // SSHKeyPath specifies a custom SSH private key file path for SFTP downloads.
    // If empty, default paths (~/.ssh/id_ed25519, ~/.ssh/id_rsa) are tried.
    // Not used for HTTP or FTP protocols.
    SSHKeyPath string
    ```

    PHASE C: RED -- Write failing tests in batches

    NOTE ON SCOPE: This plan has 46 test cases. Write tests in batches by function, implement each through RED->GREEN before moving to next.

    Batch 1: known_hosts.go TOFU tests (tests 15-22) -- known_hosts_test.go
    Batch 2: Factory + Auth + Capabilities (tests 1, 4, 9, 11, 23-24, 33-39, 42-43, 46) -- protocol_sftp_test.go, no mock server needed for most
    Batch 3: Probe + Download + Progress (tests 3, 5-8, 10, 12, 25-28, 40-41) -- mock server required
    Batch 4: Error classification + SchemeRouter (tests 29-32, 2, 44-45)

    Mock SFTP server helper (protocol_sftp_test.go):
    ```go
    // startMockSFTPServer starts an in-process SSH server with SFTP subsystem.
    // Uses crypto/ecdsa for host key generation.
    // Returns address (host:port), host public key, and cleanup function.
    func startMockSFTPServer(t *testing.T, opts ...mockSFTPOption) (addr string, hostKey ssh.PublicKey, cleanup func()) {
        t.Helper()
        // 1. Generate ECDSA host key for server
        hostPrivKey, _ := ecdsa.GenerateKey(elliptic.P256(), crand.Reader)
        hostSigner, _ := ssh.NewSignerFromKey(hostPrivKey)

        // 2. Configure SSH server
        config := &ssh.ServerConfig{}
        // Apply options (password callback, public key callback, etc.)
        for _, opt := range opts {
            opt(config)
        }
        config.AddHostKey(hostSigner)

        // 3. Listen on random port
        listener, _ := net.Listen("tcp", "127.0.0.1:0")

        // 4. Accept connections in goroutine, run SSH handshake, start SFTP server
        // Uses sftp.NewServer on the accepted SSH channel
        // Pre-populates virtual filesystem with test files:
        //   /pub/testfile.bin (1024 bytes of 0xAB)
        //   /pub/largefile.bin (65536 bytes for progress tracking)

        return listener.Addr().String(), hostSigner.PublicKey(), func() { listener.Close() }
    }
    ```

    Known hosts test structure (known_hosts_test.go):
    ```go
    func TestTOFUUnknownHost(t *testing.T) { /* test 15 */ }
    func TestTOFUKnownHostMatch(t *testing.T) { /* test 16 */ }
    func TestTOFUHostKeyMismatch(t *testing.T) { /* test 17 */ }
    func TestTOFUConcurrentAppend(t *testing.T) { /* test 18 */ }
    func TestKnownHostsNormalize(t *testing.T) { /* tests 19, 20 */ }
    func TestTOFUReReadAfterAppend(t *testing.T) { /* test 21 */ }
    func TestKnownHostsDirCreation(t *testing.T) { /* test 22 */ }
    ```

    SFTP test structure (protocol_sftp_test.go):
    ```go
    func TestSFTPFactory(t *testing.T) { /* tests 1, 33-35 */ }
    func TestSFTPPasswordAuth(t *testing.T) { /* tests 4, 5, 6 */ }
    func TestSFTPKeyAuth(t *testing.T) { /* tests 7, 8 */ }
    func TestSFTPCustomKeyPath(t *testing.T) { /* tests 9, 10 */ }
    func TestSFTPCapabilities(t *testing.T) { /* test 11 */ }
    func TestSFTPProbe(t *testing.T) { /* tests 26, 27, 28 */ }
    func TestSFTPDownloadIntegration(t *testing.T) { /* tests 3, 12 */ }
    func TestSFTPPortParsing(t *testing.T) { /* tests 23, 24, 25 */ }
    func TestClassifySFTPError(t *testing.T) { /* tests 29-32 */ }
    func TestSFTPNilHandlerSafety(t *testing.T) { /* tests 40, 41 */ }
    func TestSFTPProbeRequired(t *testing.T) { /* tests 36, 37 */ }
    func TestSFTPAuthEdgeCases(t *testing.T) { /* tests 38, 39 */ }
    func TestSFTPCredentialStripping(t *testing.T) { /* tests 42, 43 */ }
    func TestSFTPSchemeRouting(t *testing.T) { /* tests 2, 44, 45 */ }
    func TestDownloaderOptsSSHKeyPath(t *testing.T) { /* test 46 */ }
    ```

    PHASE D: GREEN -- Implement known_hosts.go

    Create pkg/warplib/known_hosts.go:

    ```go
    package warplib

    import (
        "errors"
        "fmt"
        "net"
        "os"
        "path/filepath"
        "sync"

        "golang.org/x/crypto/ssh"
        "golang.org/x/crypto/ssh/knownhosts"
    )

    // KnownHostsPath is the path to WarpDL's TOFU known_hosts file.
    // Isolated from system ~/.ssh/known_hosts to avoid polluting system SSH state.
    var KnownHostsPath = filepath.Join(ConfigDir, "known_hosts")

    // knownHostsMu serializes writes to the known_hosts file.
    // TOFU appends are rare (only on first connection to a new host),
    // but concurrent downloads to different new hosts must not corrupt the file.
    var knownHostsMu sync.Mutex

    // newTOFUHostKeyCallback creates an ssh.HostKeyCallback implementing
    // Trust-On-First-Use (TOFU) policy:
    //   - Known host with matching key: accept (return nil)
    //   - Known host with changed key: reject with MITM warning
    //   - Unknown host: auto-accept, append to known_hosts file, log fingerprint
    //
    // The callback re-reads the known_hosts file on each call (not cached at factory time)
    // so that keys appended by concurrent connections are visible immediately.
    //
    // knownHostsFile is typically KnownHostsPath (~/.config/warpdl/known_hosts).
    func newTOFUHostKeyCallback(knownHostsFile string) ssh.HostKeyCallback {
        return func(hostname string, remote net.Addr, key ssh.PublicKey) error {
            // Ensure directory exists
            if err := os.MkdirAll(filepath.Dir(knownHostsFile), 0700); err != nil {
                return fmt.Errorf("sftp: failed to create known_hosts directory: %w", err)
            }

            // Try to load existing known hosts (file may not exist yet)
            if _, err := os.Stat(knownHostsFile); err == nil {
                cb, loadErr := knownhosts.New(knownHostsFile)
                if loadErr != nil {
                    return fmt.Errorf("sftp: failed to load known_hosts: %w", loadErr)
                }
                err := cb(hostname, remote, key)
                if err == nil {
                    return nil // Host known and key matches
                }
                var keyErr *knownhosts.KeyError
                if errors.As(err, &keyErr) {
                    if len(keyErr.Want) > 0 {
                        // Key mismatch -- potential MITM. Hard reject.
                        fp := ssh.FingerprintSHA256(key)
                        return fmt.Errorf(
                            "sftp: WARNING: host key changed for %s (got %s)\n"+
                                "If this is expected, remove the old entry from %s",
                            hostname, fp, knownHostsFile,
                        )
                    }
                    // len(keyErr.Want) == 0 -> unknown host -> fall through to TOFU accept
                } else {
                    return err // Other error (revoked, etc.) -- propagate
                }
            }

            // Unknown host: auto-accept + persist
            return appendKnownHost(knownHostsFile, hostname, remote, key)
        }
    }

    // appendKnownHost writes a new host key entry to the known_hosts file.
    // Thread-safe via knownHostsMu. Uses knownhosts.Normalize for correct
    // port handling (port 22 is implicit, non-22 uses [host]:port format).
    func appendKnownHost(path, hostname string, remote net.Addr, key ssh.PublicKey) error {
        knownHostsMu.Lock()
        defer knownHostsMu.Unlock()

        f, err := os.OpenFile(path, os.O_APPEND|os.O_CREATE|os.O_WRONLY, 0600)
        if err != nil {
            return fmt.Errorf("sftp: failed to write known_hosts: %w", err)
        }
        defer f.Close()

        normalized := knownhosts.Normalize(hostname)
        line := knownhosts.Line([]string{normalized}, key)
        _, err = fmt.Fprintln(f, line)
        return err
    }
    ```

    PHASE E: GREEN -- Implement sftpProtocolDownloader (protocol_sftp.go)

    Create pkg/warplib/protocol_sftp.go:

    ```go
    package warplib

    import (
        "context"
        "crypto/rand"
        "encoding/hex"
        "errors"
        "fmt"
        "io"
        "net"
        "net/url"
        "os"
        "path"
        "path/filepath"
        "strings"
        "sync/atomic"
        "time"

        "github.com/pkg/sftp"
        "golang.org/x/crypto/ssh"
    )

    var _ ProtocolDownloader = (*sftpProtocolDownloader)(nil)

    type sftpProtocolDownloader struct {
        rawURL     string
        opts       *DownloaderOpts
        host       string   // host:port
        remotePath string   // file path on server
        user       string   // from URL userinfo -- NOT persisted
        password   string   // from URL userinfo -- NOT persisted
        sshKeyPath string   // from opts.SSHKeyPath -- NOT persisted
        fileName   string
        fileSize   int64    // set during Probe
        hash       string
        dlDir      string
        savePath   string
        probed     bool
        stopped    int32    // atomic
        cleanURL   string   // URL with credentials stripped -- safe to persist
        ctx        context.Context
        cancel     context.CancelFunc
    }
    ```

    Key methods:
    - `newSFTPProtocolDownloader(rawURL string, opts *DownloaderOpts) (ProtocolDownloader, error)` -- parse URL, extract credentials, validate path, generate hash, set defaults. Default port 22 if unspecified.
    - `connect(ctx context.Context) (*ssh.Client, *sftp.Client, error)` -- build auth methods, create TOFU callback, ssh.Dial, sftp.NewClient. Returns BOTH ssh.Client (for Close) and sftp.Client.
    - `Probe(ctx context.Context) (ProbeResult, error)` -- connect, sftpClient.Stat, get file size, disconnect
    - `Download(ctx context.Context, handlers *Handlers) error` -- connect, open remote file, io.Copy with progress writer. ALL handler calls nil-guarded.
    - `Resume(ctx, parts, handlers)` -- stub for Plan 04-02 (returns error "not yet implemented" initially)
    - `Capabilities()` -- returns {false, true}
    - `Close()`, `Stop()`, `IsStopped()` -- standard lifecycle with context cancellation
    - `GetMaxConnections()` returns 1, `GetMaxParts()` returns 1
    - Getters: `GetHash()`, `GetFileName()`, `GetDownloadDirectory()`, `GetSavePath()`, `GetContentLength()`

    Helper functions:
    - `buildAuthMethods(password, sshKeyPath string) ([]ssh.AuthMethod, error)` -- password auth if present, else try SSH keys from resolveSSHKeyPaths. Detects ssh.PassphraseMissingError.
    - `resolveSSHKeyPaths(explicitPath string) []string` -- if explicit, return [explicit]. Else return [~/.ssh/id_ed25519, ~/.ssh/id_rsa].
    - `classifySFTPError(proto, op string, err error) *DownloadError` -- os.ErrNotExist permanent, *ssh.ExitError permanent, net.Error transient, default permanent
    - `sftpProgressWriter` -- implements io.Writer, calls DownloadProgressHandler. Mirrors ftpProgressWriter exactly.

    PHASE F: Update SchemeRouter (protocol_router.go)

    In NewSchemeRouter, after ftp/ftps registration, add:
    ```go
    // Register sftp factory.
    sftpFactory := func(rawURL string, opts *DownloaderOpts) (ProtocolDownloader, error) {
        return newSFTPProtocolDownloader(rawURL, opts)
    }
    r.routes["sftp"] = sftpFactory
    ```

    PHASE G: REFACTOR -- Clean up

    After GREEN:
    - Verify known_hosts.go is cleanly separated from protocol_sftp.go (TOFU is reusable)
    - Verify all exports are minimal (only what's needed outside the package: KnownHostsPath)
    - Ensure sftpProtocolDownloader mirrors ftpProtocolDownloader structure closely for consistency
    - Run go vet, go fmt
    - Verify StripURLCredentials (from protocol_ftp.go) works for sftp:// URLs without modification
  </implementation>
</feature>

<verification>
```bash
# Install dependencies
cd /Users/divkix/GitHub/warpdl/.claude/worktrees/issues-fix && go get github.com/pkg/sftp@v1.13.10 && go get golang.org/x/crypto@v0.48.0 && go mod tidy

# Per-batch TDD cycle
# Batch 1: TOFU known_hosts
go test -v -run "TestTOFU|TestKnownHosts" ./pkg/warplib/ -count=1

# Batch 2: Factory + Auth + Capabilities
go test -v -run "TestSFTPFactory|TestSFTPPasswordAuth|TestSFTPKeyAuth|TestSFTPCustomKeyPath|TestSFTPCapabilities|TestSFTPAuthEdgeCases|TestSFTPCredentialStripping|TestDownloaderOptsSSHKeyPath" ./pkg/warplib/ -count=1

# Batch 3: Probe + Download + Progress (mock server tests)
go test -v -run "TestSFTPProbe$|TestSFTPDownloadIntegration|TestSFTPPortParsing|TestSFTPNilHandlerSafety|TestSFTPProbeRequired" ./pkg/warplib/ -count=1

# Batch 4: Error classification + SchemeRouter
go test -v -run "TestClassifySFTPError|TestSFTPSchemeRouting" ./pkg/warplib/ -count=1

# All SFTP tests
go test -v -run "TestSFTP|TestTOFU|TestKnownHosts|TestClassifySFTP" ./pkg/warplib/ -count=1

# Regression -- ALL existing tests must still pass
go test ./pkg/warplib/ -count=1

# Full suite including internal packages
go test ./... -count=1

# Race detection
go test -race -short ./pkg/warplib/

# Coverage check -- must remain >= 80%
go test -cover ./pkg/warplib/

# Vet
go vet ./...
```
</verification>

<success_criteria>
- RED: Failing tests exist for SFTP factory, auth methods, capabilities, probe, download, error classification, credential stripping, scheme routing, TOFU known_hosts
- GREEN: All tests pass after sftpProtocolDownloader and known_hosts implementation
- REFACTOR: Clean code, no unnecessary exports, TOFU separated into known_hosts.go
- sftpProtocolDownloader satisfies ProtocolDownloader (compile-time check)
- Password auth works (extracted from URL userinfo)
- SSH key auth works (default paths ~/.ssh/id_ed25519, ~/.ssh/id_rsa; custom via opts.SSHKeyPath)
- Passphrase-protected keys return clear error (not panic)
- No auth available returns descriptive error
- Credentials are NEVER stored in cleanURL -- stripped before persistence
- Download() with nil or partial *Handlers does not panic
- Single-stream download completes with correct file content
- Probe returns accurate file size and filename
- TOFU: unknown host auto-accepts and persists to known_hosts
- TOFU: known host key match passes
- TOFU: changed host key rejects with MITM warning
- TOFU: concurrent writes don't corrupt known_hosts file
- TOFU: port normalization correct (22 omitted, non-22 bracketed)
- Custom port support works (sftp://host:2222/path)
- Default port 22 when unspecified
- SchemeRouter dispatches sftp:// to SFTP factory
- go.mod has pkg/sftp v1.13.10 and x/crypto v0.48.0 as direct dependencies
- All existing tests pass (pkg/warplib, internal, cmd) -- zero regression
- go vet ./... clean
- Coverage remains >= 80% on pkg/warplib
</success_criteria>

<output>
After completion, create `.planning/phases/04-sftp/04-01-SUMMARY.md`
</output>
