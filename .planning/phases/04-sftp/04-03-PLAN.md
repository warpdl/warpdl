---
phase: 04-sftp
plan: 03
type: tdd
wave: 3
depends_on: [04-01, 04-02]
files_modified:
  - internal/api/download.go
  - internal/api/download_sftp_test.go
  - internal/api/api_test.go
  - pkg/warplib/protocol_sftp_test.go
  - pkg/warpcli/methods.go
  - cmd/download.go
  - cmd/daemon_core.go
  - common/types.go
  - scripts/check_insecure_host_key.sh
autonomous: true
requirements: [SFTP-01, SFTP-02, SFTP-04, SFTP-05, SFTP-08, SFTP-09]

must_haves:
  truths:
    - "API downloadHandler detects sftp:// URLs and dispatches through SchemeRouter instead of NewDownloader (SFTP-01)"
    - "API downloadHandler for SFTP calls Manager.AddProtocolDownload with credential-stripped URL, ProtoSFTP protocol, and correct handlers"
    - "API downloadHandler for SFTP returns DownloadResponse with correct ContentLength, DownloadId, FileName, SavePath, MaxConnections=1"
    - "API downloadHandler for SFTP starts download via go pd.Download(ctx, handlers) -- not go d.Start()"
    - "API downloadHandler preserves existing HTTP and FTP flows completely (zero regression)"
    - "API resumeHandler works for SFTP items via Manager.ResumeDownload SFTP path (delegates to Plan 04-02)"
    - "cmd/download.go has --ssh-key flag in dlFlags that passes SSHKeyPath through to DownloadParams"
    - "common/types.go DownloadParams has SSHKeyPath field serialized as json:ssh_key_path,omitempty"
    - "cmd/daemon_core.go SchemeRouter already registers sftp (from Plan 04-01 NewSchemeRouter update) -- no change needed here"
    - "warpcli.DownloadOpts has SSHKeyPath string field added (json:ssh_key_path,omitempty)"
    - "Client.Download() forwards opts.SSHKeyPath to common.DownloadParams{SSHKeyPath: opts.SSHKeyPath} so the value reaches the daemon"
    - "SFTP download with credentials: item.Url persisted to disk does NOT contain credentials (verified via GOB decode)"
    - "SFTP download reports file size in DownloadResponse.ContentLength (SFTP-09)"
    - "SFTP download response has MaxConnections=1 and MaxSegments=1 (SFTP-05)"
    - "API downloadFTPHandler is generalized to downloadProtocolHandler to handle ftp, ftps, and sftp schemes"
    - "CI gate script check_insecure_host_key.sh rejects InsecureIgnoreHostKey in non-test .go files"
  artifacts:
    - path: "internal/api/download.go"
      provides: "Updated downloadHandler scheme switch with sftp case; downloadFTPHandler generalized to downloadProtocolHandler for FTP/FTPS/SFTP"
    - path: "internal/api/download_sftp_test.go"
      provides: "Tests for API-level SFTP download dispatch, credential stripping verification, response fields"
    - path: "internal/api/api_test.go"
      provides: "Unchanged from Phase 3 -- NewApi call sites already handle SchemeRouter (nil-safe)"
    - path: "pkg/warpcli/methods.go"
      provides: "SSHKeyPath field added to DownloadOpts struct; Client.Download() updated to forward SSHKeyPath to common.DownloadParams"
    - path: "cmd/download.go"
      provides: "Added --ssh-key flag to dlFlags, passed to DownloadOpts.SSHKeyPath"
    - path: "common/types.go"
      provides: "DownloadParams with SSHKeyPath field"
    - path: "scripts/check_insecure_host_key.sh"
      provides: "CI lint gate: grep -r InsecureIgnoreHostKey --include=*.go | grep -v _test.go exits nonzero if found"
  key_links:
    - from: "internal/api/download.go:downloadHandler"
      to: "pkg/warplib/protocol_router.go:SchemeRouter.NewDownloader"
      via: "SFTP URL detection triggers SchemeRouter dispatch (alongside FTP/FTPS)"
      pattern: "schemeRouter.*NewDownloader"
    - from: "internal/api/download.go:downloadProtocolHandler"
      to: "pkg/warplib/manager.go:AddProtocolDownload"
      via: "SFTP downloads use AddProtocolDownload (same as FTP)"
      pattern: "AddProtocolDownload"
    - from: "cmd/download.go"
      to: "common/types.go:DownloadParams.SSHKeyPath"
      via: "--ssh-key CLI flag maps to SSHKeyPath in DownloadParams"
      pattern: "SSHKeyPath"
    - from: "pkg/warpcli/methods.go:Client.Download"
      to: "common/types.go:DownloadParams.SSHKeyPath"
      via: "Client.Download forwards DownloadOpts.SSHKeyPath to DownloadParams.SSHKeyPath for daemon transmission"
      pattern: "SSHKeyPath.*SSHKeyPath"
    - from: "internal/api/download.go:downloadProtocolHandler"
      to: "pkg/warplib/dloader.go:DownloaderOpts.SSHKeyPath"
      via: "SSHKeyPath from DownloadParams passed to DownloaderOpts for SFTP factory"
      pattern: "SSHKeyPath"
---

<objective>
Wire SFTP downloads through the API layer, add --ssh-key CLI flag, generalize FTP handler for SFTP, and add CI lint gate for InsecureIgnoreHostKey.

Purpose: Plans 04-01 and 04-02 build the SFTP downloader and its Manager integration at the warplib level. This plan connects the remaining dots: the API layer's downloadHandler must detect sftp:// URLs and dispatch through SchemeRouter. The existing `downloadFTPHandler` is generalized to `downloadProtocolHandler` to handle FTP, FTPS, and SFTP uniformly. The `--ssh-key` flag is added to the CLI and threaded through `DownloadParams` to the daemon. A CI lint gate script ensures `InsecureIgnoreHostKey` never appears in non-test code.

Output: Updated API download handler, --ssh-key CLI flag, DownloadParams.SSHKeyPath field, CI lint gate script, and integration tests.
</objective>

<execution_context>
@/Users/divkix/.claude/get-shit-done/workflows/execute-plan.md
@/Users/divkix/.claude/get-shit-done/templates/summary.md
@/Users/divkix/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/phases/04-sftp/04-RESEARCH.md
@.planning/phases/04-sftp/04-01-PLAN.md
@.planning/phases/04-sftp/04-02-PLAN.md

@internal/api/download.go
@internal/api/api.go
@cmd/download.go
@cmd/daemon_core.go
@common/types.go
@pkg/warpcli/methods.go
@pkg/warplib/protocol_sftp.go    (created by Plan 04-01)
@pkg/warplib/protocol_router.go
@pkg/warplib/manager.go
@pkg/warplib/dloader.go
</context>

<interfaces>
<!-- Key types and contracts the executor needs. -->

From internal/api/download.go -- current download handler with scheme detection (Phase 3):
```go
func (s *Api) downloadHandler(sconn *server.SyncConn, pool *server.Pool, body json.RawMessage) (common.UpdateType, any, error) {
    // Parses DownloadParams, extracts URL
    // Detects scheme: ftp/ftps -> downloadFTPHandler, default -> downloadHTTPHandler
    // Must add: sftp -> downloadProtocolHandler (or generalize downloadFTPHandler)
}

func (s *Api) downloadFTPHandler(sconn *server.SyncConn, pool *server.Pool, rawURL, scheme string, m *common.DownloadParams) (common.UpdateType, any, error) {
    // Creates downloader via SchemeRouter, Probe, AddProtocolDownload, go pd.Download
    // This handler is protocol-agnostic enough to handle SFTP too -- just rename and add SFTP protocol detection
}
```

From common/types.go -- DownloadParams (must add SSHKeyPath):
```go
type DownloadParams struct {
    Url               string  `json:"url"`
    DownloadDirectory string  `json:"download_directory"`
    FileName          string  `json:"file_name"`
    // ... existing fields ...
    // Must add:
    // SSHKeyPath string `json:"ssh_key_path,omitempty"`
}
```

From pkg/warplib/protocol.go -- Protocol constants:
```go
const (
    ProtoHTTP  Protocol = iota // 0
    ProtoFTP                   // 1
    ProtoFTPS                  // 2
    ProtoSFTP                  // 3
)
```

From cmd/download.go -- dlFlags (must add --ssh-key):
```go
var dlFlags = []cli.Flag{
    cli.StringFlag{Name: "file-name, o", ...},
    cli.StringFlag{Name: "download-path, l", ...},
    // ... existing flags ...
    // Must add: cli.StringFlag{Name: "ssh-key", Usage: "path to SSH private key for SFTP downloads", ...}
}
```

From pkg/warplib/dloader.go -- DownloaderOpts (SSHKeyPath added by Plan 04-01):
```go
type DownloaderOpts struct {
    // ... existing fields ...
    SSHKeyPath string  // Added by Plan 04-01
}
```

From pkg/warpcli/methods.go -- DownloadOpts (must add SSHKeyPath):
```go
type DownloadOpts struct {
    Headers             warplib.Headers `json:"headers,omitempty"`
    ForceParts          bool            `json:"force_parts,omitempty"`
    MaxConnections      int32           `json:"max_connections,omitempty"`
    MaxSegments         int32           `json:"max_segments,omitempty"`
    ChildHash           string          `json:"child_hash,omitempty"`
    IsHidden            bool            `json:"is_hidden,omitempty"`
    IsChildren          bool            `json:"is_children,omitempty"`
    Overwrite           bool            `json:"overwrite,omitempty"`
    Proxy               string          `json:"proxy,omitempty"`
    Timeout             int             `json:"timeout,omitempty"`
    MaxRetries          int             `json:"max_retries,omitempty"`
    RetryDelay          int             `json:"retry_delay,omitempty"`
    SpeedLimit          string          `json:"speed_limit,omitempty"`
    DisableWorkStealing bool            `json:"disable_work_stealing,omitempty"`
    Priority            int             `json:"priority,omitempty"`
    // Must add:
    // SSHKeyPath string `json:"ssh_key_path,omitempty"`
}

// Client.Download() builds common.DownloadParams from DownloadOpts.
// Currently does NOT forward SSHKeyPath. Must add:
//   SSHKeyPath: opts.SSHKeyPath,
// to the DownloadParams literal in Client.Download().
```
</interfaces>

<feature>
  <name>API Layer SFTP Integration, --ssh-key Flag, and CI Lint Gate</name>
  <files>internal/api/download.go, internal/api/download_sftp_test.go, internal/api/api_test.go, cmd/download.go, common/types.go, pkg/warplib/protocol_sftp_test.go, scripts/check_insecure_host_key.sh</files>
  <behavior>
    Test cases for API downloadHandler SFTP dispatch:
    1. downloadHandler with sftp://user:pass@host/file.iso URL creates SFTP downloader via SchemeRouter
    2. downloadHandler with sftp:// URL returns DownloadResponse with MaxConnections=1, MaxSegments=1
    3. downloadHandler with sftp:// URL returns DownloadResponse with correct FileName from path.Base
    4. downloadHandler with sftp:// URL returns DownloadResponse with ContentLength from Probe
    5. downloadHandler with sftp:// URL and SSHKeyPath set passes SSHKeyPath to DownloaderOpts
    6. downloadHandler with http:// URL still uses existing downloadHTTPHandler (zero regression)
    7. downloadHandler with ftp:// URL still dispatches correctly (zero regression)

    Credential security:
    8. After downloadHandler with sftp://user:pass@host/file, Manager.GetItem(hash).Url does NOT contain "@"
    9. After downloadHandler with sftp://user:pass@host/file, Manager.GetItem(hash).Url does NOT contain "pass"
    10. GOB-encode the Manager, decode, verify persisted Url field still has no credentials

    API resumeHandler SFTP:
    11. resumeHandler with SFTP item delegates to Manager.ResumeDownload SFTP path
    12. resumeHandler response for SFTP item has correct MaxConnections=1

    CLI flag:
    13. --ssh-key flag exists in dlFlags
    14. --ssh-key value is passed through to DownloadOpts.SSHKeyPath

    DownloadParams:
    15. DownloadParams marshals/unmarshals SSHKeyPath as "ssh_key_path" in JSON

    CI lint gate:
    16. scripts/check_insecure_host_key.sh exits 0 when no InsecureIgnoreHostKey in non-test files
    17. scripts/check_insecure_host_key.sh exits 1 when InsecureIgnoreHostKey found in non-test .go file

    Error cases:
    18. downloadHandler with sftp://host/ (no file path) returns error from SFTP factory
    19. downloadHandler with sftp:// URL where server is unreachable returns error from Probe
  </behavior>
  <implementation>
    PHASE A: Add SSHKeyPath to common/types.go DownloadParams

    In common/types.go, add to DownloadParams:
    ```go
    // SSHKeyPath specifies a custom SSH private key file path for SFTP downloads.
    // If empty, default SSH key paths (~/.ssh/id_ed25519, ~/.ssh/id_rsa) are tried.
    SSHKeyPath string `json:"ssh_key_path,omitempty"`
    ```

    PHASE B: Add SSHKeyPath to warpcli.DownloadOpts and forward in Client.Download()

    In pkg/warpcli/methods.go:

    1. Add SSHKeyPath field to the DownloadOpts struct (after the existing Priority field):
    ```go
    // SSHKeyPath specifies a custom SSH private key file path for SFTP downloads.
    // If empty, default SSH key paths (~/.ssh/id_ed25519, ~/.ssh/id_rsa) are tried.
    SSHKeyPath string `json:"ssh_key_path,omitempty"`
    ```

    2. Update Client.Download() method body to forward SSHKeyPath in the common.DownloadParams literal.
    Add this line alongside the other field mappings (after Priority: opts.Priority):
    ```go
    SSHKeyPath: opts.SSHKeyPath,
    ```

    Without BOTH changes, the --ssh-key CLI flag value is silently dropped at the CLI layer and never reaches the daemon. This is the critical link in the chain: cmd/download.go -> warpcli.DownloadOpts.SSHKeyPath -> common.DownloadParams.SSHKeyPath -> daemon API -> warplib.DownloaderOpts.SSHKeyPath -> SFTP factory.

    PHASE C: Add --ssh-key CLI flag

    In cmd/download.go, add to dlFlags:
    ```go
    cli.StringFlag{
        Name:  "ssh-key",
        Usage: "path to SSH private key file for SFTP downloads (default: ~/.ssh/id_ed25519 or ~/.ssh/id_rsa)",
    },
    ```

    In the download() function, pass the flag value to warpcli.DownloadOpts (which Phase B added SSHKeyPath to):
    ```go
    d, err := client.Download(url, fileName, dlPath, &warpcli.DownloadOpts{
        // ... existing fields ...
        SSHKeyPath: ctx.String("ssh-key"),
    })
    ```

    This completes the full threading chain:
    CLI --ssh-key flag -> warpcli.DownloadOpts.SSHKeyPath (Phase B) -> common.DownloadParams.SSHKeyPath (Phase A) -> API -> warplib.DownloaderOpts.SSHKeyPath (Plan 04-01) -> SFTP factory

    Also add to downloadBatchFromFile if batch downloads should support SFTP (likely not needed for v1, but add for completeness).

    PHASE D: RED -- Write failing API tests

    Create internal/api/download_sftp_test.go:
    ```go
    package api

    func TestDownloadHandlerSFTP(t *testing.T) { /* tests 1-5, 18-19 */ }
    func TestDownloadHandlerHTTPAndFTPRegression(t *testing.T) { /* tests 6-7 */ }
    func TestDownloadHandlerSFTPCredentialSecurity(t *testing.T) { /* tests 8-10 */ }
    func TestResumeHandlerSFTP(t *testing.T) { /* tests 11-12 */ }
    ```

    NOTE: If API tests are too infrastructure-heavy, focus on warplib-level integration tests (already covered by 04-01 and 04-02) and simpler tests that verify URL scheme detection logic.

    The credential security test (test 8-10) is NON-NEGOTIABLE and MUST exist.

    PHASE E: GREEN -- Generalize downloadFTPHandler to downloadProtocolHandler

    The key insight: `downloadFTPHandler` in internal/api/download.go is already protocol-agnostic. It uses SchemeRouter.NewDownloader(), which dispatches to the correct factory. The only FTP-specific part is the protocol detection (`ProtoFTP` vs `ProtoFTPS`). Rename and generalize:

    In internal/api/download.go:

    1. Rename `downloadFTPHandler` to `downloadProtocolHandler`
    2. Update the scheme switch to include sftp:
    ```go
    switch scheme {
    case "ftp", "ftps", "sftp":
        return s.downloadProtocolHandler(sconn, pool, dlURL, scheme, &m)
    default:
        return s.downloadHTTPHandler(sconn, pool, dlURL, &m)
    }
    ```

    3. Update protocol detection inside `downloadProtocolHandler`:
    ```go
    // Determine protocol constant
    var proto warplib.Protocol
    switch scheme {
    case "ftp":
        proto = warplib.ProtoFTP
    case "ftps":
        proto = warplib.ProtoFTPS
    case "sftp":
        proto = warplib.ProtoSFTP
    }
    ```

    4. Pass SSHKeyPath from DownloadParams to DownloaderOpts:
    ```go
    pd, err := s.schemeRouter.NewDownloader(rawURL, &warplib.DownloaderOpts{
        FileName:          m.FileName,
        DownloadDirectory: m.DownloadDirectory,
        SSHKeyPath:        m.SSHKeyPath,  // NEW: forward SSH key path
    })
    ```

    PHASE F: Create CI lint gate script

    Create scripts/check_insecure_host_key.sh:
    ```bash
    #!/usr/bin/env bash
    # CI lint gate: ensures InsecureIgnoreHostKey is never used in non-test Go files.
    # ssh.InsecureIgnoreHostKey() silently accepts all host keys, defeating TOFU security.
    # Only test files (_test.go) are allowed to use it.
    set -euo pipefail

    matches=$(grep -rn "InsecureIgnoreHostKey" --include="*.go" . | grep -v "_test.go" || true)
    if [ -n "$matches" ]; then
        echo "ERROR: InsecureIgnoreHostKey found in non-test files:"
        echo "$matches"
        echo ""
        echo "Use newTOFUHostKeyCallback() instead of ssh.InsecureIgnoreHostKey()"
        exit 1
    fi
    echo "OK: No InsecureIgnoreHostKey in non-test files"
    exit 0
    ```

    chmod +x scripts/check_insecure_host_key.sh

    PHASE G: REFACTOR

    - Verify HTTP path is completely unchanged (zero regression)
    - Verify FTP path is completely unchanged (no logic changes from rename)
    - Verify all handler closures in downloadProtocolHandler reference pd (not d) for the download ID
    - Run the InsecureIgnoreHostKey lint gate against the codebase
    - Run full test suite
  </implementation>
</feature>

<verification>
```bash
# Per-task TDD cycle
go test -v -run "TestDownloadHandler" ./internal/api/ -count=1
go test -v -run "TestResumeHandler" ./internal/api/ -count=1

# CLI flag compilation check
go build -ldflags="-w -s" .

# All SFTP tests across packages
go test -v -run "TestSFTP|TestDownloadHandlerSFTP|TestResumeHandlerSFTP" ./... -count=1

# Regression -- ALL existing tests must still pass (especially HTTP and FTP download handlers)
go test ./internal/api/ -count=1
go test ./pkg/warplib/ -count=1
go test ./... -count=1

# Race detection
go test -race -short ./...

# Coverage check -- must remain >= 80% per package
scripts/check_coverage.sh

# InsecureIgnoreHostKey lint gate
scripts/check_insecure_host_key.sh

# Vet
go vet ./...

# Build succeeds (binary compiles)
make build
```
</verification>

<success_criteria>
- RED: Failing tests exist for API SFTP dispatch, credential security, CLI flag
- GREEN: All tests pass after API update and CLI wiring
- REFACTOR: Clean generalization of downloadFTPHandler -> downloadProtocolHandler with zero logic change to FTP path
- API detects sftp:// URLs and dispatches through SchemeRouter
- API returns correct DownloadResponse for SFTP (MaxConnections=1, ContentLength from Probe)
- SSHKeyPath is threaded from --ssh-key CLI flag -> warpcli.DownloadOpts.SSHKeyPath -> common.DownloadParams.SSHKeyPath -> warplib.DownloaderOpts.SSHKeyPath -> SFTP factory
- warpcli.DownloadOpts has SSHKeyPath field AND Client.Download() forwards it to DownloadParams (without this, the value is silently dropped)
- NON-NEGOTIABLE: Credentials in SFTP URL are NEVER persisted to Item.Url (security critical -- verified by GOB round-trip test)
- HTTP download path is completely unchanged (zero regression)
- FTP/FTPS download path is completely unchanged (zero regression from rename)
- cmd/daemon_core.go needs NO changes (SchemeRouter already registers sftp from Plan 04-01 NewSchemeRouter update)
- Binary builds successfully with make build
- scripts/check_insecure_host_key.sh exits 0 on current codebase
- All existing tests pass across all packages -- zero regression
- go vet ./... clean
- Coverage remains >= 80% per package
</success_criteria>

<output>
After completion, create `.planning/phases/04-sftp/04-03-SUMMARY.md`
</output>
