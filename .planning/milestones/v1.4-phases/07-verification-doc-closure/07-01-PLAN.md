---
phase: 07-verification-doc-closure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/phases/03-ftp-ftps/03-01-SUMMARY.md
  - .planning/phases/03-ftp-ftps/03-02-SUMMARY.md
  - .planning/phases/03-ftp-ftps/03-03-SUMMARY.md
  - .planning/phases/05-json-rpc-20/05-01-SUMMARY.md
  - .planning/phases/05-json-rpc-20/05-02-SUMMARY.md
  - .planning/phases/05-json-rpc-20/05-03-SUMMARY.md
  - .planning/phases/01-http-redirect/01-01-SUMMARY.md
  - .planning/phases/01-http-redirect/01-02-SUMMARY.md
  - .planning/phases/05-json-rpc-20/05-04-SUMMARY.md
autonomous: true
requirements: [FTP-01, FTP-02, FTP-03, FTP-04, FTP-05, FTP-06, FTP-07, FTP-08, RPC-01, RPC-02, RPC-03, RPC-04, RPC-05, RPC-07, RPC-08, RPC-09, RPC-10, RPC-12, REDIR-01, REDIR-02, REDIR-03]

must_haves:
  truths:
    - "Every phase 3 plan (03-01, 03-02, 03-03) has a SUMMARY.md file with correct requirements-completed frontmatter"
    - "Every phase 5 plan (05-01, 05-02, 05-03) has a SUMMARY.md file with correct requirements-completed frontmatter"
    - "Phase 1 SUMMARY files (01-01, 01-02) have requirements-completed frontmatter populated (not empty)"
    - "Phase 5 05-04-SUMMARY.md has requirements-completed frontmatter populated (not empty)"
    - "Every FTP requirement (FTP-01 through FTP-08) appears in at least one Phase 3 SUMMARY requirements-completed"
    - "Every RPC requirement (RPC-01 through RPC-12 except RPC-06 and RPC-11) appears in at least one Phase 5 SUMMARY requirements-completed"
    - "REDIR-01, REDIR-02, REDIR-03 appear in 01-01-SUMMARY requirements-completed; REDIR-04 appears in 01-02-SUMMARY"
  artifacts:
    - path: ".planning/phases/03-ftp-ftps/03-01-SUMMARY.md"
      provides: "Phase 3 plan 01 summary with requirements-completed: [FTP-01, FTP-02, FTP-03, FTP-04, FTP-05, FTP-06, FTP-07, FTP-08]"
    - path: ".planning/phases/03-ftp-ftps/03-02-SUMMARY.md"
      provides: "Phase 3 plan 02 summary with requirements-completed: [FTP-06, FTP-07]"
    - path: ".planning/phases/03-ftp-ftps/03-03-SUMMARY.md"
      provides: "Phase 3 plan 03 summary with requirements-completed: [FTP-01, FTP-03, FTP-05, FTP-08]"
    - path: ".planning/phases/05-json-rpc-20/05-01-SUMMARY.md"
      provides: "Phase 5 plan 01 summary with requirements-completed: [RPC-01, RPC-03, RPC-04]"
    - path: ".planning/phases/05-json-rpc-20/05-02-SUMMARY.md"
      provides: "Phase 5 plan 02 summary with requirements-completed: [RPC-05, RPC-07, RPC-08, RPC-09, RPC-10, RPC-12]"
    - path: ".planning/phases/05-json-rpc-20/05-03-SUMMARY.md"
      provides: "Phase 5 plan 03 summary with requirements-completed: [RPC-02, RPC-11]"
  key_links:
    - from: "03-01-SUMMARY.md requirements-completed"
      to: "03-01-PLAN.md requirements field"
      via: "requirements-completed must be superset of PLAN requirements (commit consolidated Resume+FTPS)"
    - from: "05-04-SUMMARY.md requirements-completed"
      to: "05-04-PLAN.md requirements field"
      via: "integration tests verified all 12 RPC requirements"
---

<objective>
Create missing SUMMARY files for Phase 3 (FTP) and Phase 5 (JSON-RPC), and fix incomplete SUMMARY frontmatter for Phase 1 and Phase 5/05-04.

Purpose: SUMMARY files with correct `requirements-completed` frontmatter are the second leg of the 3-source cross-reference (VERIFICATION + SUMMARY + traceability). Without them, 21 requirements remain orphaned or unsatisfied per the milestone audit.

Output: 6 new SUMMARY files created, 3 existing SUMMARY files updated with requirements-completed frontmatter.
</objective>

<execution_context>
@/Users/divkix/.claude/get-shit-done/workflows/execute-plan.md
@/Users/divkix/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-verification-doc-closure/07-RESEARCH.md
@.planning/v1.0-MILESTONE-AUDIT.md

Reference for SUMMARY format:
@.planning/phases/02-protocol-interface/02-01-SUMMARY.md
@.planning/phases/04-sftp/04-01-SUMMARY.md

Reference for what was implemented per plan:
@.planning/phases/03-ftp-ftps/03-01-PLAN.md (frontmatter only — requirements field)
@.planning/phases/03-ftp-ftps/03-02-PLAN.md (frontmatter only)
@.planning/phases/03-ftp-ftps/03-03-PLAN.md (frontmatter only)
@.planning/phases/05-json-rpc-20/05-01-PLAN.md (frontmatter only)
@.planning/phases/05-json-rpc-20/05-02-PLAN.md (frontmatter only)
@.planning/phases/05-json-rpc-20/05-03-PLAN.md (frontmatter only)
@.planning/phases/05-json-rpc-20/05-04-PLAN.md (frontmatter only)
@.planning/phases/01-http-redirect/01-01-SUMMARY.md (needs frontmatter fix)
@.planning/phases/01-http-redirect/01-02-SUMMARY.md (needs frontmatter fix)
@.planning/phases/05-json-rpc-20/05-04-SUMMARY.md (needs frontmatter fix)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Phase 3 (FTP/FTPS) SUMMARY files and fix Phase 1 SUMMARY frontmatter</name>
  <files>
    .planning/phases/03-ftp-ftps/03-01-SUMMARY.md
    .planning/phases/03-ftp-ftps/03-02-SUMMARY.md
    .planning/phases/03-ftp-ftps/03-03-SUMMARY.md
    .planning/phases/01-http-redirect/01-01-SUMMARY.md
    .planning/phases/01-http-redirect/01-02-SUMMARY.md
  </files>
  <action>
    **CRITICAL: This is a documentation-only task. Do NOT create or modify any Go source files.**

    **Create 03-01-SUMMARY.md:**
    Use the format from `02-01-SUMMARY.md` as template. Frontmatter must include:
    ```yaml
    phase: 03-ftp-ftps
    plan: 01
    subsystem: core
    tags: [go, ftp, protocol, tdd]
    requires:
      - phase: 02-protocol-interface
        provides: "ProtocolDownloader interface and SchemeRouter"
    provides:
      - "ftpProtocolDownloader implementing ProtocolDownloader for ftp:// and ftps:// URLs"
      - "StripURLCredentials for secure URL persistence"
      - "patchProtocolHandlers for wiring event callbacks to protocol downloaders"
    tech-stack:
      added: [github.com/jlaffaye/ftp v0.2.0]
      patterns: [single-stream download, factory registration, progress writer adapter]
    key-files:
      created:
        - pkg/warplib/protocol_ftp.go
        - pkg/warplib/protocol_ftp_test.go
      modified:
        - pkg/warplib/protocol_router.go
        - pkg/warplib/manager.go
        - go.mod
        - go.sum
    key-decisions:
      - "FTP uses single-stream download (SupportsParallel=false, MaxConnections=1) — jlaffaye/ftp ServerConn is not goroutine-safe"
      - "StripURLCredentials exported from warplib for cross-package use in API layer"
      - "classifyFTPError uses standard errors.As (not generic wrapper) — 4xx transient, 5xx permanent, net.Error transient"
      - "Commit e053d93 consolidated Resume() and FTPS TLS into this plan (originally scoped for 03-02)"
    requirements-completed: [FTP-01, FTP-02, FTP-03, FTP-04, FTP-05, FTP-06, FTP-07, FTP-08]
    duration: 15min
    completed: 2026-02-27
    ```

    Body: Brief description of what was built — ftpProtocolDownloader with Probe/Download/Resume, anonymous and credential auth, passive mode (EPSV default via jlaffaye/ftp), FTPS explicit TLS, single-stream download, file size reporting. Note that commit e053d93 consolidated Resume and FTPS from planned 03-02 scope.

    Commits: `e053d93` — Plan 03-01 implementation.

    **IMPORTANT on requirements-completed:** The PLAN file says `[FTP-01, FTP-02, FTP-03, FTP-04, FTP-05, FTP-08]` but commit e053d93 actually consolidated Resume (FTP-06) and FTPS (FTP-07) into this plan. The SUMMARY must reflect what was ACTUALLY built, not just what was planned. Use `[FTP-01, FTP-02, FTP-03, FTP-04, FTP-05, FTP-06, FTP-07, FTP-08]`.

    **Create 03-02-SUMMARY.md:**
    Frontmatter:
    ```yaml
    phase: 03-ftp-ftps
    plan: 02
    subsystem: core
    tags: [go, ftp, resume, manager]
    requires:
      - phase: 03-ftp-ftps
        plan: 01
        provides: "ftpProtocolDownloader with Resume() method"
    provides:
      - "Manager.ResumeDownload FTP/FTPS dispatch via SchemeRouter"
      - "Manager.SetSchemeRouter method for daemon core initialization"
      - "Protocol-specific integrity guard (skips validateDownloadIntegrity for FTP)"
    tech-stack:
      added: []
      patterns: [protocol guard switch, scheme router dispatch]
    key-files:
      created: []
      modified:
        - pkg/warplib/manager.go
        - pkg/warplib/protocol_ftp.go
        - pkg/warplib/protocol_ftp_test.go
    key-decisions:
      - "Manager.ResumeDownload uses protocol guard (switch on item.Protocol) to skip validateDownloadIntegrity for FTP items"
      - "FTP resume offset derived from destination file size on disk (WarpStat), not from parts map"
    requirements-completed: [FTP-06, FTP-07]
    duration: 15min
    completed: 2026-02-27
    ```

    Body: Note that Resume() and FTPS TLS were already implemented in 03-01 (consolidated). This plan focused on Manager.ResumeDownload dispatch — routing FTP/FTPS items through SchemeRouter when resume is requested. Added protocol guard in integrity validation. Commit: `28eab3c`.

    **Create 03-03-SUMMARY.md:**
    Frontmatter:
    ```yaml
    phase: 03-ftp-ftps
    plan: 03
    subsystem: api
    tags: [go, ftp, api, daemon, integration]
    requires:
      - phase: 03-ftp-ftps
        plan: 01
        provides: "ftpProtocolDownloader"
      - phase: 03-ftp-ftps
        plan: 02
        provides: "Manager.ResumeDownload FTP dispatch"
    provides:
      - "API layer FTP dispatch (downloadFTPHandler extracted from downloadHTTPHandler)"
      - "SchemeRouter initialization in daemon core"
      - "Credential stripping verified by GOB round-trip test"
    tech-stack:
      added: []
      patterns: [handler extraction, scheme routing, credential stripping]
    key-files:
      created:
        - internal/api/download_ftp_test.go
      modified:
        - internal/api/api.go
        - internal/api/download.go
        - internal/api/resume.go
        - internal/api/api_test.go
        - cmd/daemon_core.go
    key-decisions:
      - "downloadHandler refactored into downloadHTTPHandler + downloadFTPHandler — zero logic change to HTTP path"
      - "Api struct gains schemeRouter field; NewApi signature updated with router parameter (nil-safe for tests)"
    requirements-completed: [FTP-01, FTP-03, FTP-05, FTP-08]
    duration: 15min
    completed: 2026-02-27
    ```

    Body: API layer wiring — downloadFTPHandler detects ftp/ftps URLs and routes through SchemeRouter. daemon_core.go initializes SchemeRouter and passes to NewApi. Credential stripping verified by GOB round-trip test (TestFTPCredentialSecurityGOBRoundTrip). Commits: `9e61af2`, `74c97e0`.

    **Fix 01-01-SUMMARY.md frontmatter:**
    Add `requirements-completed: [REDIR-01, REDIR-02, REDIR-03]` to the existing YAML frontmatter. The body text already says "Requirements REDIR-01, REDIR-02, REDIR-03 addressed." Do NOT change anything else in the file.

    **Fix 01-02-SUMMARY.md frontmatter:**
    Add `requirements-completed: [REDIR-04]` to the existing YAML frontmatter. The body text already says "Requirement REDIR-04 addressed." Do NOT change anything else in the file.
  </action>
  <verify>
    Verify all 5 files exist and have correct requirements-completed in frontmatter:
    - `grep 'requirements-completed:' .planning/phases/03-ftp-ftps/03-01-SUMMARY.md` shows FTP-01 through FTP-08
    - `grep 'requirements-completed:' .planning/phases/03-ftp-ftps/03-02-SUMMARY.md` shows FTP-06, FTP-07
    - `grep 'requirements-completed:' .planning/phases/03-ftp-ftps/03-03-SUMMARY.md` shows FTP-01, FTP-03, FTP-05, FTP-08
    - `grep 'requirements-completed:' .planning/phases/01-http-redirect/01-01-SUMMARY.md` shows REDIR-01, REDIR-02, REDIR-03
    - `grep 'requirements-completed:' .planning/phases/01-http-redirect/01-02-SUMMARY.md` shows REDIR-04
  </verify>
  <done>
    Phase 3 has 3 SUMMARY files with correct frontmatter. Phase 1 SUMMARY files have requirements-completed populated. Every FTP-* and REDIR-* requirement appears in at least one SUMMARY.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Phase 5 (JSON-RPC) SUMMARY files and fix 05-04 frontmatter</name>
  <files>
    .planning/phases/05-json-rpc-20/05-01-SUMMARY.md
    .planning/phases/05-json-rpc-20/05-02-SUMMARY.md
    .planning/phases/05-json-rpc-20/05-03-SUMMARY.md
    .planning/phases/05-json-rpc-20/05-04-SUMMARY.md
  </files>
  <action>
    **CRITICAL: This is a documentation-only task. Do NOT create or modify any Go source files.**

    **Create 05-01-SUMMARY.md:**
    Frontmatter:
    ```yaml
    phase: 05-json-rpc-20
    plan: 01
    subsystem: daemon
    tags: [go, jsonrpc, http, auth, localhost]
    requires:
      - phase: 02-protocol-interface
        provides: "SchemeRouter for protocol dispatch in download.add"
    provides:
      - "JSON-RPC 2.0 HTTP endpoint at /jsonrpc"
      - "Auth token middleware (requireToken)"
      - "Localhost binding by default, --rpc-listen-all for all interfaces"
      - "system.getVersion method"
      - "Standard JSON-RPC 2.0 error codes (-32700, -32601, -32602)"
    tech-stack:
      added: [github.com/creachadair/jrpc2 v1.3.4]
      patterns: [middleware auth, jrpc2 handler map, localhost binding]
    key-files:
      created:
        - internal/server/rpc_auth.go
        - internal/server/rpc_auth_test.go
        - internal/server/rpc_methods.go
        - internal/server/rpc_methods_test.go
      modified:
        - internal/server/web.go
        - internal/server/web_test.go
        - internal/server/server.go
        - cmd/cmd.go
        - cmd/daemon_core.go
        - go.mod
        - go.sum
    key-decisions:
      - "Uses creachadair/jrpc2 (not gorilla/rpc or net/rpc) for full JSON-RPC 2.0 compliance"
      - "Auth token via --rpc-secret flag and WARPDL_RPC_SECRET env var"
      - "Localhost binding default protects against browser tab CSRF attacks (CVE-2025-52882 precedent)"
    requirements-completed: [RPC-01, RPC-03, RPC-04]
    duration: 30min
    completed: 2026-02-27
    ```

    Body: HTTP endpoint registered at /jsonrpc on existing web server (port+1). Auth token required via `requireToken` middleware. Localhost binding by default, `--rpc-listen-all` opt-in. system.getVersion returns daemon version info. Standard error codes for parse errors (-32700), method not found (-32601), invalid params (-32602). Commit: `a1484b2`.

    Note: The PLAN also listed RPC-10 and RPC-12 in requirements but the primary implementation was system.getVersion (RPC-10) and error codes (RPC-12) were foundational — both are attributed here but the method suite and error testing are primarily in 05-02 and 05-04.

    **Create 05-02-SUMMARY.md:**
    Frontmatter:
    ```yaml
    phase: 05-json-rpc-20
    plan: 02
    subsystem: daemon
    tags: [go, jsonrpc, methods, download, rpc]
    requires:
      - phase: 05-json-rpc-20
        plan: 01
        provides: "JSON-RPC 2.0 HTTP endpoint and auth middleware"
    provides:
      - "download.add method (start downloads via RPC)"
      - "download.pause and download.resume methods"
      - "download.remove method"
      - "download.status method (state, progress, speed)"
      - "download.list method (filter by active/waiting/stopped)"
    tech-stack:
      added: []
      patterns: [jrpc2 handler methods, manager delegation, error code mapping]
    key-files:
      created: []
      modified:
        - internal/server/rpc_methods.go
        - internal/server/rpc_methods_test.go
        - internal/server/web.go
        - internal/server/server.go
        - cmd/daemon_core.go
    key-decisions:
      - "download.add dispatches HTTP URLs via warplib.NewDownloader, FTP/SFTP via schemeRouter.NewDownloader"
      - "download.pause calls item.StopDownload(), not Manager-level stop"
      - "Custom error codes: -32001 (download not found), -32002 (download not running)"
    requirements-completed: [RPC-05, RPC-07, RPC-08, RPC-09, RPC-10, RPC-12]
    duration: 30min
    completed: 2026-02-27
    ```

    Body: Full method suite implemented — download.add accepts URL+options and starts download, download.pause/resume control lifecycle, download.remove clears from manager, download.status returns full state, download.list filters by status. system.getVersion returns configured version. Error codes (-32001 not found, -32002 not running) added. RPC-06 (pause/resume) was implemented but had a defect in resume path (fixed in Phase 6). Commit: `2df0db3`.

    **Create 05-03-SUMMARY.md:**
    Frontmatter:
    ```yaml
    phase: 05-json-rpc-20
    plan: 03
    subsystem: daemon
    tags: [go, jsonrpc, websocket, push-notifications, realtime]
    requires:
      - phase: 05-json-rpc-20
        plan: 01
        provides: "JSON-RPC 2.0 HTTP endpoint and auth"
      - phase: 05-json-rpc-20
        plan: 02
        provides: "RPC method suite (download.add triggers notifications)"
    provides:
      - "WebSocket endpoint at /jsonrpc/ws"
      - "RPCNotifier for broadcasting push notifications to all connected clients"
      - "Real-time notifications: download.started, download.progress, download.complete, download.error"
    tech-stack:
      added: [github.com/coder/websocket v1.8.14]
      patterns: [WebSocket upgrade, server push, broadcast registry]
    key-files:
      created:
        - internal/server/rpc_notify.go
        - internal/server/rpc_notify_test.go
      modified:
        - internal/server/rpc_methods.go
        - internal/server/web.go
        - internal/server/server.go
    key-decisions:
      - "Uses coder/websocket (not gorilla/websocket — archived)"
      - "RPCNotifier maintains thread-safe registry of jrpc2.Server instances"
      - "Broadcast errors log and unregister disconnected servers (no block/panic)"
    requirements-completed: [RPC-02, RPC-11]
    duration: 30min
    completed: 2026-02-27
    ```

    Body: WebSocket endpoint at /jsonrpc/ws with auth-required upgrade. RPCNotifier broadcasts download.started, download.progress, download.complete, download.error to all connected WebSocket clients. download.add handler wires event callbacks to notifier.Broadcast. Disconnected servers are gracefully unregistered. RPC-11 had a defect in the resume path (no push notifications for resumed downloads) — fixed in Phase 6. Commit: `b62f9cf`.

    **Fix 05-04-SUMMARY.md frontmatter:**
    The file currently has NO YAML frontmatter (just a markdown heading). Add frontmatter at the top of the file:
    ```yaml
    ---
    phase: 05-json-rpc-20
    plan: 04
    subsystem: daemon
    tags: [go, jsonrpc, integration-tests, race-detection, coverage]
    requires:
      - phase: 05-json-rpc-20
        plan: 01
        provides: "JSON-RPC HTTP endpoint"
      - phase: 05-json-rpc-20
        plan: 02
        provides: "RPC method suite"
      - phase: 05-json-rpc-20
        plan: 03
        provides: "WebSocket + push notifications"
    provides:
      - "14 end-to-end integration tests covering all 12 RPC requirements"
      - "Race condition fixes for thread-safe item field access"
    tech-stack:
      added: []
      patterns: [integration testing, race detection, thread-safe getters]
    key-files:
      created:
        - internal/server/rpc_integration_test.go
      modified:
        - internal/server/rpc_methods.go
        - internal/server/rpc_methods_test.go
        - internal/server/web_test.go
        - pkg/warplib/item.go
        - pkg/warplib/manager.go
    key-decisions:
      - "GetDownloaded() and GetTotalSize() thread-safe getters added to Item"
      - "part.Compiled mutation moved under item lock to prevent GOB encoder race"
    requirements-completed: [RPC-01, RPC-02, RPC-03, RPC-04, RPC-05, RPC-07, RPC-08, RPC-09, RPC-10, RPC-12]
    duration: 30min
    completed: 2026-02-27
    ---
    ```

    Insert this frontmatter BEFORE the existing `# Plan 05-04 Summary: Integration Tests and CI Gate` heading. Do NOT change the existing body content.

    Note: requirements-completed lists all RPC reqs except RPC-06 and RPC-11 (those had defects found during integration testing, fixed in Phase 6). The integration tests verified these 10 requirements end-to-end.
  </action>
  <verify>
    Verify all 4 files exist and have correct requirements-completed:
    - `grep 'requirements-completed:' .planning/phases/05-json-rpc-20/05-01-SUMMARY.md` shows RPC-01, RPC-03, RPC-04
    - `grep 'requirements-completed:' .planning/phases/05-json-rpc-20/05-02-SUMMARY.md` shows RPC-05, RPC-07, RPC-08, RPC-09, RPC-10, RPC-12
    - `grep 'requirements-completed:' .planning/phases/05-json-rpc-20/05-03-SUMMARY.md` shows RPC-02, RPC-11
    - `grep 'requirements-completed:' .planning/phases/05-json-rpc-20/05-04-SUMMARY.md` shows RPC-01..RPC-12 minus RPC-06 and RPC-11
  </verify>
  <done>
    Phase 5 has 4 SUMMARY files with correct frontmatter. Every RPC-* requirement (except RPC-06 and RPC-11 which are Phase 6 scope) appears in at least one Phase 5 SUMMARY.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, verify:
1. `ls .planning/phases/03-ftp-ftps/*SUMMARY*` shows 3 files (03-01, 03-02, 03-03)
2. `ls .planning/phases/05-json-rpc-20/*SUMMARY*` shows 4 files (05-01, 05-02, 05-03, 05-04)
3. Every requirement ID from the phase requirements list appears in at least one SUMMARY's requirements-completed field
4. Phase 1 SUMMARY files have non-empty requirements-completed
5. No Go source files were created or modified
</verification>

<success_criteria>
- 6 new SUMMARY files created (03-01, 03-02, 03-03, 05-01, 05-02, 05-03)
- 3 existing SUMMARY files updated (01-01, 01-02, 05-04)
- All SUMMARY files have valid YAML frontmatter with requirements-completed field
- Every FTP-*, RPC-*, and REDIR-* requirement from the phase requirement list appears in at least one SUMMARY
- Zero Go source files touched
</success_criteria>

<output>
After completion, create `.planning/phases/07-verification-doc-closure/07-01-SUMMARY.md`
</output>
