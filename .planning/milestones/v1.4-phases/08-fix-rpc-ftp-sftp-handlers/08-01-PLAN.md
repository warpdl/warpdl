---
phase: 08-fix-rpc-ftp-sftp-handlers
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - internal/server/rpc_methods.go
  - internal/server/rpc_ftp_sftp_notify_test.go
requirements:
  - RPC-05
  - RPC-11
autonomous: true

must_haves:
  truths:
    - "FTP/SFTP downloads started via JSON-RPC `download.add` emit WebSocket push notifications (download.progress, download.complete) to connected clients"
    - "`download.status` reports non-zero `completedLength` for FTP/SFTP downloads in progress (item.Downloaded updated during download, not only at completion)"
    - "Tests prove handler callbacks are invoked during FTP/SFTP RPC download.add (not just that nil is replaced syntactically)"
    - "All tests pass with `-race` flag (pd.Download runs in a goroutine, handler callbacks mutate item.Downloaded under mutex)"
    - "Server package test coverage remains >= 80%"
  artifacts:
    - path: "internal/server/rpc_ftp_sftp_notify_test.go"
      provides: "Mock ProtocolDownloader, test helper, and 3 test functions verifying handler wiring for FTP/SFTP RPC download.add"
    - path: "internal/server/rpc_methods.go"
      provides: "Two nil→opts.Handlers fixes in downloadAdd default branch (lines ~242, ~259)"
  key_links:
    - from: "internal/server/rpc_methods.go:downloadAdd"
      to: "pkg/warplib/manager.go:AddProtocolDownload"
      via: "opts.Handlers passed instead of nil so patchProtocolHandlers updates item.Downloaded"
      pattern: "AddProtocolDownload.*opts\\.Handlers"
    - from: "internal/server/rpc_methods.go:downloadAdd"
      to: "pkg/warplib/protocol.go:ProtocolDownloader.Download"
      via: "opts.Handlers passed instead of nil so DownloadProgressHandler and DownloadCompleteHandler fire"
      pattern: "pd\\.Download.*opts\\.Handlers"
---

<objective>
Wire opts.Handlers in RPC downloadAdd FTP/SFTP branch and add tests proving handler callbacks fire.

Purpose: After this plan, FTP/SFTP downloads started via JSON-RPC `download.add` will emit WebSocket push notifications and update `item.Downloaded` during download (fixing INT-01 tech debt).

Output: 2-line production fix in rpc_methods.go, new test file with mock ProtocolDownloader and 3 test functions.
</objective>

<execution_context>
@/Users/divkix/.claude/get-shit-done/workflows/execute-plan.md
@/Users/divkix/.claude/get-shit-done/templates/summary.md
@/Users/divkix/.claude/get-shit-done/references/tdd.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md
@.planning/REQUIREMENTS.md
@.planning/phases/08-fix-rpc-ftp-sftp-handlers/08-RESEARCH.md

@internal/server/rpc_methods.go (lines 219-260: downloadAdd default branch with nil handler args)
@internal/server/rpc_methods_test.go (existing test patterns, newTestRPCHandlerWithManager helper)
@internal/server/rpc_resume_notify_test.go (handler wiring test pattern from Phase 6)
@pkg/warplib/protocol.go (ProtocolDownloader interface — 14 methods, DownloadCapabilities struct)
@pkg/warplib/manager.go (lines 268-305: AddProtocolDownload, lines 323: patchProtocolHandlers nil guard)
@pkg/warplib/handlers.go (Handlers struct with callback fields)
@internal/api/download.go (downloadProtocolHandler — correct handler wiring reference pattern)
</context>

<interfaces>
<!-- Key types and contracts the executor needs. -->

ProtocolDownloader interface (14 methods — ALL must be implemented by mock):
```go
// From pkg/warplib/protocol.go
type ProtocolDownloader interface {
    Probe(ctx context.Context) (ProbeResult, error)
    Download(ctx context.Context, handlers *Handlers) error
    Resume(ctx context.Context, parts map[int64]*ItemPart, handlers *Handlers) error
    Capabilities() DownloadCapabilities
    Close() error
    Stop()
    IsStopped() bool
    GetMaxConnections() int32
    GetMaxParts() int32
    GetHash() string
    GetFileName() string
    GetDownloadDirectory() string
    GetSavePath() string
    GetContentLength() ContentLength
}
```

DownloadCapabilities (NOT ProtocolCapabilities — that type does not exist):
```go
// From pkg/warplib/protocol.go
type DownloadCapabilities struct {
    SupportsParallel bool
    SupportsResume   bool
}
```

Handlers struct (relevant callback fields):
```go
// From pkg/warplib/handlers.go
type Handlers struct {
    ErrorHandler             func(hash string, err error)
    DownloadProgressHandler  func(hash string, nread int)
    DownloadCompleteHandler  func(hash string, tread int64)
    DownloadStoppedHandler   func()
    // ... other fields not relevant to this fix
}
```

patchProtocolHandlers nil guard:
```go
// From pkg/warplib/manager.go:323
func (m *Manager) patchProtocolHandlers(h *Handlers, item *Item) {
    if h == nil {
        return  // ← THIS is why nil handlers cause silent no-op
    }
    // ... wraps h.DownloadProgressHandler to also update item.Downloaded
    // ... wraps h.DownloadCompleteHandler to set item.Downloaded = item.TotalSize when hash == MAIN_HASH
}
```

The defect (2 lines in rpc_methods.go downloadAdd default branch):
```go
// Line ~242: nil instead of opts.Handlers
rs.manager.AddProtocolDownload(pd, probe, cleanURL, proto, nil, &warplib.AddDownloadOpts{...})
// Line ~259: nil instead of opts.Handlers
go pd.Download(context.Background(), nil)
```

The fix:
```go
// Line ~242: opts.Handlers instead of nil
rs.manager.AddProtocolDownload(pd, probe, cleanURL, proto, opts.Handlers, &warplib.AddDownloadOpts{...})
// Line ~259: opts.Handlers instead of nil
go pd.Download(context.Background(), opts.Handlers)
```
</interfaces>

<feature>
  <name>RPC FTP/SFTP Handler Wiring Fix with TDD</name>
  <files>internal/server/rpc_ftp_sftp_notify_test.go, internal/server/rpc_methods.go</files>
  <behavior>
    Task 1 (RED) — Write failing tests FIRST:

    Create internal/server/rpc_ftp_sftp_notify_test.go with:

    A. mockProtocolDownloader struct implementing ALL 14 ProtocolDownloader interface methods:
    ```go
    type mockProtocolDownloader struct {
        hash            string
        fileName        string
        downloadDir     string
        contentLength   int64
        probed          bool
        stopped         bool
        doneCh          chan struct{} // buffered(1), signals Download completed
        progressCalled  int32         // atomic counter
        completeCalled  int32         // atomic counter
    }
    ```
    Methods:
    - Probe(ctx): sets m.probed = true, returns ProbeResult{FileName: m.fileName, ContentLength: m.contentLength, Resumable: true}
    - Download(ctx, h *Handlers): if !m.probed return ErrProbeRequired; if h != nil: call h.DownloadProgressHandler(m.hash, 512) with atomic increment, call h.DownloadCompleteHandler(warplib.MAIN_HASH, m.contentLength) with atomic increment; close(m.doneCh); return nil
    - Resume(ctx, parts, h): return nil (not exercised)
    - Capabilities(): return DownloadCapabilities{SupportsParallel: false, SupportsResume: true}
    - Close(): return nil
    - Stop(): m.stopped = true
    - IsStopped(): return m.stopped
    - GetMaxConnections(): return 1
    - GetMaxParts(): return 1
    - GetHash(): return m.hash
    - GetFileName(): return m.fileName
    - GetDownloadDirectory(): return m.downloadDir
    - GetSavePath(): return m.downloadDir + "/" + m.fileName
    - GetContentLength(): return ContentLength(m.contentLength)

    CRITICAL: Download MUST call h.DownloadCompleteHandler with warplib.MAIN_HASH (not m.hash) because patchProtocolHandlers only finalizes item.Downloaded = item.TotalSize when hash == MAIN_HASH.
    CRITICAL: doneCh MUST be buffered(1) so close doesn't block.

    B. newTestRPCHandlerWithRouter helper that creates an RPCServer with a custom SchemeRouter.

    C. Three test functions:
    - TestRPCDownloadAdd_FTP_ProgressTracked: registers mock for "ftp", calls download.add with ftp:// URL, waits on doneCh with 5s deadline, asserts item.GetDownloaded() >= item.GetTotalSize() and item.GetTotalSize() > 0
    - TestRPCDownloadAdd_SFTP_ProgressTracked: same but for "sftp" scheme
    - TestRPCDownloadAdd_FTP_HandlerCallbacksFired: registers mock for "ftp", calls download.add, waits on doneCh, asserts atomic.LoadInt32(mock.progressCalled) > 0 and atomic.LoadInt32(mock.completeCalled) > 0

    Tests MUST FAIL before the fix (because nil handlers → mock.Download receives nil h → progressCalled/completeCalled stay 0, item.Downloaded stays 0).

    Task 2 (GREEN) — Apply production fix to make tests pass:

    Replace two nil arguments with opts.Handlers in rpc_methods.go downloadAdd default branch:
    1. Line ~242: nil → opts.Handlers in AddProtocolDownload call
    2. Line ~259: nil → opts.Handlers in go pd.Download call

    All 3 tests must pass after this change.

    Task 3 (GATE) — Full suite + coverage verification.
  </behavior>
  <implementation>
    Strict TDD red-green-refactor. Task 1 writes failing tests. Task 2 applies the 2-line fix. Task 3 gates.
  </implementation>
</feature>

<task type="auto">
  <name>Task 1: Write failing tests for FTP/SFTP handler wiring in RPC downloadAdd (RED)</name>
  <files>internal/server/rpc_ftp_sftp_notify_test.go</files>
  <action>
Create `internal/server/rpc_ftp_sftp_notify_test.go` in package `server`.

**Step 1: Define mockProtocolDownloader struct implementing all 14 ProtocolDownloader methods.**

```go
package server

import (
    "context"
    "sync/atomic"
    "testing"
    // ... other imports

    "github.com/warpdl/warpdl/pkg/warplib"
)

type mockProtocolDownloader struct {
    hash            string
    fileName        string
    downloadDir     string
    contentLength   int64
    probed          bool
    stopped         bool
    doneCh          chan struct{}
    progressCalled  int32 // atomic
    completeCalled  int32 // atomic
}

func (m *mockProtocolDownloader) Probe(_ context.Context) (warplib.ProbeResult, error) {
    m.probed = true
    return warplib.ProbeResult{
        FileName:      m.fileName,
        ContentLength: m.contentLength,
        Resumable:     true,
    }, nil
}

func (m *mockProtocolDownloader) Download(_ context.Context, h *warplib.Handlers) error {
    if !m.probed {
        return warplib.ErrProbeRequired
    }
    if h != nil {
        if h.DownloadProgressHandler != nil {
            atomic.AddInt32(&m.progressCalled, 1)
            h.DownloadProgressHandler(m.hash, 512)
        }
        if h.DownloadCompleteHandler != nil {
            atomic.AddInt32(&m.completeCalled, 1)
            // MUST use MAIN_HASH — patchProtocolHandlers only finalizes item
            // when hash == MAIN_HASH
            h.DownloadCompleteHandler(warplib.MAIN_HASH, m.contentLength)
        }
    }
    close(m.doneCh)
    return nil
}

func (m *mockProtocolDownloader) Resume(_ context.Context, _ map[int64]*warplib.ItemPart, _ *warplib.Handlers) error {
    return nil
}

func (m *mockProtocolDownloader) Capabilities() warplib.DownloadCapabilities {
    return warplib.DownloadCapabilities{SupportsParallel: false, SupportsResume: true}
}

func (m *mockProtocolDownloader) Close() error                          { return nil }
func (m *mockProtocolDownloader) Stop()                                 { m.stopped = true }
func (m *mockProtocolDownloader) IsStopped() bool                       { return m.stopped }
func (m *mockProtocolDownloader) GetMaxConnections() int32              { return 1 }
func (m *mockProtocolDownloader) GetMaxParts() int32                    { return 1 }
func (m *mockProtocolDownloader) GetHash() string                       { return m.hash }
func (m *mockProtocolDownloader) GetFileName() string                   { return m.fileName }
func (m *mockProtocolDownloader) GetDownloadDirectory() string          { return m.downloadDir }
func (m *mockProtocolDownloader) GetSavePath() string                   { return m.downloadDir + "/" + m.fileName }
func (m *mockProtocolDownloader) GetContentLength() warplib.ContentLength { return warplib.ContentLength(m.contentLength) }
```

**Step 2: Define newTestRPCHandlerWithRouter helper.**

Copy the pattern from `newTestRPCHandlerWithManager` in existing test files, but pass the `router` argument to `NewRPCServer` instead of nil. The helper should:
- Accept `(t *testing.T, router *warplib.SchemeRouter)` as parameters
- Return `(http.Handler, string, func(), *warplib.Manager, string)` (handler, secret, cleanup, manager, dlDir)
- Be identical to `newTestRPCHandlerWithManager` except it passes `router` to `NewRPCServer`

**Step 3: Write TestRPCDownloadAdd_FTP_ProgressTracked.**

- Create a `warplib.NewSchemeRouter(http.DefaultClient)`
- Create a `mockProtocolDownloader{hash: "test-ftp-hash", fileName: "test.bin", downloadDir: dlDir, contentLength: 1024, doneCh: make(chan struct{}, 1)}`
- Register a factory for "ftp" scheme that returns the mock
- Create RPC handler via `newTestRPCHandlerWithRouter(t, router)`
- Call `download.add` with `{"url": "ftp://example.com/test.bin", "dir": dlDir}`
- Assert response has no error and has a `gid`
- Wait on `mock.doneCh` with 5-second deadline (timeout = test failure)
- Retrieve `item := m.GetItem(gid)` (or use the hash from the mock)
- Assert `item.GetDownloaded() >= item.GetTotalSize()` and `item.GetTotalSize() > 0`

**Step 4: Write TestRPCDownloadAdd_SFTP_ProgressTracked.**

Same pattern as FTP but:
- Register factory for "sftp" scheme
- URL: `"sftp://user:pass@example.com/test.bin"`
- Verify same `item.Downloaded` assertion

**Step 5: Write TestRPCDownloadAdd_FTP_HandlerCallbacksFired.**

Same mock setup as FTP test, but after waiting on doneCh:
- Assert `atomic.LoadInt32(&mock.progressCalled) > 0`
- Assert `atomic.LoadInt32(&mock.completeCalled) > 0`
- This test specifically proves handler callbacks were invoked (not just that item state changed)

**Step 6: Verify tests FAIL (RED).**

Run:
```bash
go test -run "TestRPCDownloadAdd_FTP|TestRPCDownloadAdd_SFTP" ./internal/server/ -v -count=1
```

Tests MUST fail because the current code passes nil handlers to pd.Download, so:
- mock.Download receives nil h → progressCalled/completeCalled stay 0
- patchProtocolHandlers receives nil → item.Downloaded stays 0

If tests pass before the fix, the mock is wrong (it's testing nothing). Fix the mock.
  </action>
  <verify>
    <automated>go test -run "TestRPCDownloadAdd_FTP|TestRPCDownloadAdd_SFTP" ./internal/server/ -v -count=1 2>&1 | grep -c FAIL</automated>
    Tests must FAIL (RED phase). At least 1 FAIL line expected. If 0 FAIL lines, mock is incorrect.
  </verify>
  <done>
- New file `internal/server/rpc_ftp_sftp_notify_test.go` exists
- Mock implements all 14 ProtocolDownloader interface methods (compiles cleanly: `go build ./internal/server/...`)
- 3 test functions defined: TestRPCDownloadAdd_FTP_ProgressTracked, TestRPCDownloadAdd_SFTP_ProgressTracked, TestRPCDownloadAdd_FTP_HandlerCallbacksFired
- Tests fail because nil handlers in downloadAdd prevent mock callbacks from firing
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix nil handler pass in downloadAdd FTP/SFTP branch (GREEN)</name>
  <files>internal/server/rpc_methods.go</files>
  <action>
Replace two `nil` arguments with `opts.Handlers` in the `default:` case of `downloadAdd` in `internal/server/rpc_methods.go`.

**Step 1: Find line ~242 (inside downloadAdd, default case):**
```go
if err := rs.manager.AddProtocolDownload(pd, probe, cleanURL, proto, nil, &warplib.AddDownloadOpts{
```
Change `nil` to `opts.Handlers`:
```go
if err := rs.manager.AddProtocolDownload(pd, probe, cleanURL, proto, opts.Handlers, &warplib.AddDownloadOpts{
```

**Step 2: Find line ~259 (same function, same case):**
```go
go pd.Download(context.Background(), nil)
```
Change `nil` to `opts.Handlers`:
```go
go pd.Download(context.Background(), opts.Handlers)
```

**Step 3: Verify compilation.**
```bash
go vet ./internal/server/...
go build ./...
```

**Step 4: Run tests (GREEN).**
```bash
go test -run "TestRPCDownloadAdd_FTP|TestRPCDownloadAdd_SFTP" ./internal/server/ -race -v -count=1
```

All 3 tests must now PASS. The fix wires opts.Handlers (built at lines 170-191 with notifier closures) into both AddProtocolDownload (so patchProtocolHandlers updates item.Downloaded) and pd.Download (so handler callbacks fire).

**Exactly 2 lines changed.** Do NOT construct new handlers — opts.Handlers is already built before the scheme switch at lines 170-191.
  </action>
  <verify>
    <automated>go test -run "TestRPCDownloadAdd_FTP|TestRPCDownloadAdd_SFTP" ./internal/server/ -race -v -count=1</automated>
    All 3 tests must PASS (GREEN phase).
  </verify>
  <done>
- Exactly 2 lines changed in `rpc_methods.go`
- Both `nil` replaced with `opts.Handlers`
- No other lines modified
- `go vet ./internal/server/...` passes
- `go build ./...` compiles
- All 3 new tests pass with `-race` flag
  </done>
</task>

<task type="auto">
  <name>Task 3: Run full suite and coverage gate</name>
  <files></files>
  <action>
Run the complete test suite with race detection and verify coverage thresholds.

**Step 1: Full project tests.**
```bash
go test -race -short ./...
```
Must pass with zero failures.

**Step 2: Server package coverage.**
```bash
go test -cover ./internal/server/...
```
Must be >= 80% (currently 86.0%).

**Step 3: Formatting and vet.**
```bash
go vet ./...
go fmt ./...
```
Must report no issues and no formatting changes.

**Step 4: Verify no nil remains at handler positions.**
```bash
grep -n 'nil' internal/server/rpc_methods.go
```
Confirm nil no longer appears at the AddProtocolDownload or pd.Download handler argument positions in the default branch of downloadAdd.
  </action>
  <verify>
    <automated>go test -race -short ./... && go test -cover ./internal/server/... && go vet ./...</automated>
  </verify>
  <done>
- Zero test failures across entire project with `-race -short`
- Server package coverage >= 80%
- No vet warnings
- Code properly formatted
- No nil at handler positions in downloadAdd default branch
  </done>
</task>

<verification>
```bash
cd /Users/divkix/GitHub/warpdl/.claude/worktrees/issues-fix

# Per-task: new tests pass with race detection
go test -run "TestRPCDownloadAdd_FTP|TestRPCDownloadAdd_SFTP" ./internal/server/ -race -v -count=1

# Full server suite
go test ./internal/server/... -race -count=1

# Phase gate
go test -race -short ./...
go test -cover ./internal/server/...
go vet ./...
```
</verification>

<success_criteria>
- FTP/SFTP downloads via RPC download.add emit handler callbacks (proven by atomic counters in mock)
- item.Downloaded is updated during FTP/SFTP RPC downloads (proven by item.GetDownloaded() assertion)
- Tests pass with -race flag (no data races in goroutine-based pd.Download)
- Server package coverage >= 80%
- Zero regressions in full test suite
</success_criteria>

<output>
After completion, create `.planning/phases/08-fix-rpc-ftp-sftp-handlers/08-01-SUMMARY.md`
</output>
